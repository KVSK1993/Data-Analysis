---
title: "Anaysis of Toxic Chemical Release By US Industrial Facilities"
output:
  html_document:
    toc: yes
  word_document: default
  pdf_document:
    keep_tex: yes
    latex_engine: xelatex
    number_sections: yes
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

##**Problem**
With the growth of industries in the United States, the amount of production waste that is generated by the industrial facilities is also increasing. But whether with the increase of production waste, the amount of recycling or recovery or treatment of these produced chemicals is also increasing or not?. Are the industrial facilities only aiming at increasing their production of goods or are they also thinking of environment by reusing the production Waste?We will find out whether the toxic release of chemicals by industrial facilities in United States have decreased or increased and also whether industrial facilities are moving towards lesser waste generation and more environmental friendly production activities over a period of years(2006 to 2016).What is the current level of the toxic chemicals that are being produced?



##**Data**

The data used for analysis is Toxic Release Inventory data. It's a freely accessible dataset that is maintained by Environmental Protection Agency (EPA), an agency of the United States federal government which aims to safeguard human and environmental health.
The dataset consists of chemical release information that is submitted by industrial facilities in various sectors such as metal mining, coal mining, electric utilities, food, paper, Plastic and rubber etc annually. Each year the industrial facilities in U.S. that meet the threshold requirements have to submit a form for each TRI listed chemical that they are processing or utilising in producing the goods giving the details of the amount of release, recycle, recovery, treatment etc. While most of these chemicals used in production of the goods are managed by the industrial facilities i.e. by recycling the waste or doing energy recovery or by Treatment of the wastes produced, so that release into the environment is minimised but still some proportion of these gets released into the environment in the form of air, water and land releases. The industrial facilities that have ten or more than ten employees(full-time) need to report about their usage of chemicals meeting certain threshold.

For the year 2016, nearly 21000 industrial facilities submitted their chemical release details to EPA.

The dataset consists of 108 attributes. Some of the key attributes of the dataset and their brief explanation is as follow.

 + Year : Year in which the chemicals were released.
 + Tri Facility ID : TRI facility identification number assigned by EPA.(Nominal)
 + Facility Name : Name of the Industrial Facility.(Nominal)
 + Street Address : Address of the facility where it is located.(Nominal)
 + City : Name of the city where the facility is located.(Categorical)
 + County : Name of the county where the facility is located(Categorical)
 + ST : Name of the state where the facility is located(Categorical)
 + Tribe : The name of the Tribe(Categorical)
 + Latitude : Latitude of the facility in decimal(Continuous)
 + Longitude : Longitude of the facility in decimal(Continuous)
 + Federal Facility : Whether the facility is federal or not(Categorical)
 + Industry Sector Code : A code that identifies the industry sector like metal mining, food etc of the facility.(Categorical)
 + Industry Sector : The sector to which facility belongs to.(Categorical)
 + Primary SIC : Primary standard industrial code(SIC) that represents the facility's primary business activity.(Categorical)
 + Primary NAICS : Primary North American Industry Code System (NAICS) code that represents the facility's primary business activity.(Categorical)
 + Chemical : Name of the chemical.(Categorical)
 + Clean Air Act Chemical : Indication if the chemical is a Clean Air Act Chemical (Yes or No) (Categorical)
 + Classification : Classification of the chemical.(Categorical)
 + Metal : Whether a chemical is metal or not(Categorical)
 + Carcinogen : Indication if the chemical is a carcinogen (Yes or No) (Categorical)
 + Unit of Measure : Units of measurement for the chemical (Pounds)(Categorical)
 + Fugitive Air : On-site Fugitive Air Releases (emissions of gases or vapors from pressurized equipment due to leaks and other unintended or irregular releases of gases)(Continuous)
 + Stack Air : On-site Stack Air  Releases(gases and solids that come out of the smoke stack after the incineration process)(Continuous)
 + Water : On-site Water Releases(Continuous) #can add more here
 + On-site Release Total : Total Releases On-site for a chemical at a facility(Continuous)
 + POTW : Transfers for Release : total amount of a chemical that is transferred to a POTW for release.(Continuous)
 + POTW : Transfers for Treatment : total amount of a chemical that is transferred to a POTW for treatment.(Continuous)
 + M10: Off-site Storage  (Continuous)
 + M41 : Off-site Solidification/Stabilization for Metals (Continuous)
 + M62 : Off-site Wastewater Treatment for Metals(Continuous)
 + Off-Site Release Total : Total chemical that is released offsite(Continuous)
 + Off-Site Recycled Total : Total chemical that is recycled offsite(Continuous)
 + Off-Site Recovery Total : Total chemical that is recovered offsite(Continuous)
 + Off-Site Treated Total : Total chemical that is treated offsite(Continuous)
 + Total Releases : Amount of Total On- and Off-site Release.(Continuous)
 + Energy Recovery On-site : Amount of Energy Recovery On-site (Continuous)
 + Energy Recovery Off-site : Amount of Energy Recovery Off-site(Continuous)
 + Recycling On-Site : Amount of Recycling On-site.(Continuous)
 + Recycling Off-Site : Amount of Recycling Off-site.(Continuous)
 + Treatment On-site : Amount of Treatment On-site.(Continuous)
 + Treatment Off-site : Amount of Treatment Off-site.(Continuous)
 + Production Waste : The Total Production Waste Quantity.(Continuous)
 + One-time Release : Quantity released to the environment as a result of remedial actions, catastrophic events, or one-time events not associated with production processing(Continuous)
 + Parent CO Name : Name of Parent Company.(Nominal)

Some of the columns for which more than 90% of the entries were 0 have been used in combination with other variables.

**New Variates Created**

In the dataset, there were around 30 different types of industry sectors.Using "forcats" package fct_collapse function, I combined the industry sectors which had very minimal production waste quantity and put them into one common category namely "Others".

Also, in the analysis, only those units have been taken into consideration for which the unit of measure for chemical waste is in pounds as only 1161 units out of the total(95469) units had the measurements in grams and these quantities were negligible in comparison to those in pounds.
The analysis is based on mainland USA along with Alaska and Hawaii.

There were some duplicate rows in the dataset which were removed by applying unique function.

 + TOTAL_RECYLE = Total onsite Recyle + Total Offsite Recyle

 + TOTAL_RECOVERY = Total onsite Recovery + Total Offsite Recovery

 + TOTAl_TREATMENT = Total onsite Treatment + Total Offsite Treatment

 + TOTAl_REUSE = TOTAL_RECYLE + TOTAL_RECOVERY + TOTAl_TREATMENT

Some other variables have also been created by combining datasets of two years (2006 and 2016) and combining other datasets for example finding the percent change in releases between the two years etc.

 + **Target Population:**It is the population for which we would like to make some inferences.Here, the target population are the industrial facilities and their toxic chemical releases, recycling and treatment activities in the future years and the industrial facilities which do not report to EPA of their chemical production waste and releases but produce chemical wastes.


 + **Study population:** the industrial facilities in United States and their toxic chemical releases, recycling and treatment activities of those chemicals every year that report to EPA. 
 
There might be study error but the size of the error may not be knowable as the target population contains industrial toxic chemical releases from the future years. 

 + An **individual unit** consists of a industrial facility and its chemical release, recycling and treatment quantities along with other related parameters for that particular chemical.
 
 + **Sample:**The industrial facilities and their toxic chemical releases, recycling and treatment activities of those chemicals that reported to EPA in the year 2006 and 2016.
 
There can be sample error because the sample which we have does not include all industrial facilities of the United States for a particular year and there might be an industry which has significant chemical release and it's not part of our sample.Also the industries that have less than 10 employees or whose chemical release is below certain threshold are not in the sample.Also only those chemicals that are in the TRI list are reported by industrial Facilities and there might be some other chemicals that are being released and not reported as they are not in the list.Hence resulting in sample error. 


**Measurement Error:**
This is the common source of error which is always present in any kind of study.
The measurement error may be due to the type of instrument that is being used to take the measurements or due to the operator who is taking the measurements or due to some other reasons.
The problems that might be associated with the measuring process include:

 + The instrument used by industrial facilities to measure the quantity of chemicals may not be accurate.
 + The person who is measuring these quantities may not take accurate measurements.
 + The calculated total quantity of chemical released may not be correct as some of it might get leaked.
 + Also the instruments that are being used by various industrial facilities may not be of good quality.
 + Also the instruments that are being used by various industrial facilities for measurements may not be properly calibrated.

###**Other Datasets Used**


**US Population Dataset**

The dataset contains the population statistics for each of the states in United States for the year 2016.The attributes include :

 + State : Name of the US state(Categorical, Nominal)
 + Population : Population of the state in 2016(Continuous,Infinite Discrete)
 + State Abbreviations : Abbreviation of the US state(Categorical)

**Chemical By Health Effects**

The dataset consists of the information of what all health effects and which parts/systems of the human body are affected by each of the TRI listed chemical that is released into environment by the US industrial Facilities.Some of the key attributes of the dataset are as follow :

 + Chemical : Name of the chemical(Categorical, Nominal)
 + Body Weight : Indicates whether Chemical is associated with body weight health effects.
 + Cardiovascular : Indicates whether Chemical is associated with cardiovascular health effects.
 + Dermal : Indicates whether Chemical is associated with dermal health effects.Referring to the skin or scalp.
 + Endocrine : Indicates whether Chemical is associated with endocrine health effects. Referring to hormones and the glands that produce them.
 + Gastrointestinal : Indicates whether Chemical is associated with gastrointestinal health effects. Referring to all parts of the digestive tract. 
 + Neurological : Indicates whether Chemical is associated with neurological health effects. Referring to the brain, spinal cord, and nerves. 
 + Renal : Indicates whether Chemical is  associated with renal health effects.Referring to the kidneys. 
 + Reproductive : Indicates whether Chemical is associated with reproductive health effects. Referring to the system required for the production of offspring. 
 + Respiratory : Indicates whether Chemical is  associated with respiratory health effects. Referring to the exchange of oxygen for carbon dioxide.
 + OSHA Carcinogens : Indicates whether Chemical is classified as carcinogen or not. 

A new variate was created by summing up all the categories for each of the chemmical.

**What answers we want to know from the data?**

 + Whether the toxic chemical releases over a period of 10 years have increased or decreased in the United States?
 + Which industry sector in United States is causing the maximum Toxic Chemical Release?
 + Which industry sector  in United States is reusing the Total Production Waste maximum?
 + Which state's industrial facilities in United States has the maximum Toxic Chemical Release?
 + Whether the number of industries in a state is related to the population of that state ?
 + Whether the number of industries in a state is related to the total release of that state?
 + Whether the total production waste of a state's industrial facilities is related to the total reuse of waste by that state's industrial facilities?
 + Whether the total reuse of the production waste generated have increased or decreased over a period of ten years?
 + Which state's industrial facilities in United States has the maximum Recycling?
 + Which state's industrial facilities in United States has the maximum Reuse of the production waste generated?
 + Over the period of ten years, which industry sector has decreased its total Chemical Toxic Release?
 + Over the period of ten years, which industry sector has increased its total reuse of Chemical Toxic Release?

#**Analysis**

##State Wise Analysis

```{r libraries, include=FALSE}
library(plotly)
library(dplyr)
library(ggplot2)
library(scatterpie)
library(ggmap)

#loading csv files
TRI2016 <- read.csv("C:\\Users\\kv3singh\\Desktop\\Karan\\Toxic Emissions\\2007to2015\\TRI_2016_US.csv")
TRI2006 <- read.csv("C:\\Users\\kv3singh\\Desktop\\Karan\\Toxic Emissions\\2007to2015\\TRI_2006_US.csv")

#Calculating Total Release
TRI2016$TOTAL_RELEASES <- TRI2016$TOTAL_RELEASES - TRI2016$X6.1_POTW.TRANSFERS_FOR_RELEASE

#Changing NA's to zero  for one time production
TRI2016$`X8.8_ONE.TIME_RELEASE`[is.na(TRI2016$`X8.8_ONE.TIME_RELEASE`)] <- 0

#creating new variates Total Recyle, Total Recovery and total treatment for 2016
TRI2016 <- dplyr::mutate(TRI2016, TOTAL_RECYLE = X8.4_RECYCLING_ON.SITE+X8.5_RECYCLING_OFF.SITE , 
                TOTAL_RECOVERY = X8.2_ENERGY_RECOVERY_ON.SITE + X8.3_ENERGY_RECOVERY_OFF.SITE,
                TOTAl_TREATMENT = X8.6_TREATMENT_ON.SITE + X8.7_TREATMENT_OFF.SITE)
#Total Reuse by each facility

TRI2016$TOTAL_REUSE <-TRI2016$TOTAL_RECYLE+TRI2016$TOTAL_RECOVERY+TRI2016$TOTAl_TREATMENT
 



#same for 2006
TRI2006$TOTAL_RELEASES <- TRI2006$TOTAL_RELEASES - TRI2006$X6.1_POTW.TRANSFERS_FOR_RELEASE
TRI2006$`X8.8_ONE.TIME_RELEASE`[is.na(TRI2006$`X8.8_ONE.TIME_RELEASE`)] <- 0

TRI2006 <- dplyr::mutate(TRI2006, TOTAL_RECYLE = X8.4_RECYCLING_ON.SITE+X8.5_RECYCLING_OFF.SITE ,
              TOTAL_RECOVERY = X8.2_ENERGY_RECOVERY_ON.SITE + X8.3_ENERGY_RECOVERY_OFF.SITE,
              TOTAl_TREATMENT = X8.6_TREATMENT_ON.SITE + X8.7_TREATMENT_OFF.SITE)

TRI2006$TOTAL_REUSE <-TRI2006$TOTAL_RECYLE+TRI2006$TOTAL_RECOVERY+TRI2006$TOTAl_TREATMENT


#getting unique rows 
TRI2016 <- unique(TRI2016)
TRI2006 <- unique(TRI2006)

filterPound2016<-TRI2016 %>% 
  dplyr::select(YEAR,FACILITY_NAME,STREET_ADDRESS,CITY,COUNTY,ST,TRIBE,LATITUDE,LONGITUDE,FEDERAL_FACILITY,TRIBE,
         INDUSTRY_SECTOR,CHEMICAL,CLEAR_AIR_ACT_CHEMICAL,CLASSIFICATION,METAL,METAL_CATEGORY,CARCINOGEN,CAS_..COMPOUND_ID,
         UNIT_OF_MEASURE,TRI_FACILITY_ID,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER,OFF.SITE_RELEASE_TOTAL,OFF.SITE_RECYCLED_TOTAL,
         OFF.SITE_RECOVERY_TOTAL,OFF.SITE_TREATED_TOTAL,TOTAL_RELEASES,TOTAL_RECYLE,X8.9_PRODUCTION_RATIO,
         TOTAL_RECOVERY,TOTAl_TREATMENT,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.,X8.8_ONE.TIME_RELEASE)%>% 
  dplyr::filter( UNIT_OF_MEASURE == "Pounds")%>% 
  dplyr::filter(!(ST %in% c('AS','GU','MP','PR','VI','DC')))

filterPound2006<-TRI2006 %>% 
  dplyr::select(YEAR,FACILITY_NAME,STREET_ADDRESS,CITY,COUNTY,ST,TRIBE,LATITUDE,LONGITUDE,FEDERAL_FACILITY,TRIBE,
         INDUSTRY_SECTOR,CHEMICAL,CLEAR_AIR_ACT_CHEMICAL,CLASSIFICATION,METAL,METAL_CATEGORY,CARCINOGEN,CAS_..COMPOUND_ID,
         UNIT_OF_MEASURE,TRI_FACILITY_ID,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER,OFF.SITE_RELEASE_TOTAL,OFF.SITE_RECYCLED_TOTAL,
         OFF.SITE_RECOVERY_TOTAL,OFF.SITE_TREATED_TOTAL,TOTAL_RELEASES,TOTAL_RECYLE,X8.9_PRODUCTION_RATIO,
         TOTAL_RECOVERY,TOTAl_TREATMENT,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.,X8.8_ONE.TIME_RELEASE)%>% 
  dplyr::filter( UNIT_OF_MEASURE == "Pounds")%>% 
  dplyr::filter(!(ST %in% c('AS','GU','MP','PR','VI','DC')))
rm(TRI2016)
rm(TRI2006)


#combining industries
library(forcats)
filterPound2016$INDUSTRY_SECTOR <- fct_collapse(filterPound2016$INDUSTRY_SECTOR, Petroleum = c("Petroleum", "Petroleum Bulk Terminals"), Chemicals = c("Chemical Wholesalers", "Chemicals"), Other = c("", "Apparel","Beverages","Computers and Electronic Products","Electrical Equipment","Fabricated Metals","Furniture","Leather","Machinery",
"Miscellaneous Manufacturing" ,"Nonmetallic Mineral Product","Printing","Publishing","Textile Product","Textiles","Tobacco", "Transportation Equipment" , "Wood Products" ))

filterPound2006$INDUSTRY_SECTOR <- fct_collapse(filterPound2006$INDUSTRY_SECTOR, Petroleum = c("Petroleum", "Petroleum Bulk Terminals"), Chemicals = c("Chemical Wholesalers", "Chemicals"), Other = c("", "Apparel","Beverages","Computers and Electronic Products","Electrical Equipment","Fabricated Metals","Furniture","Leather","Machinery",
"Miscellaneous Manufacturing" ,"Nonmetallic Mineral Product","Printing","Publishing","Textile Product","Textiles","Tobacco", "Transportation Equipment" , "Wood Products" ))


```


```{r pie MAP plot, include=FALSE}
#########################PLOTTING PIE CHART for EACH STATE 2016 on MAp###################
usa_center = as.numeric(geocode("United States"))
avgLongLat2016<-filterPound2016 %>% 
  dplyr::group_by(ST) %>% 
  dplyr::summarize(mean_Long = mean(LONGITUDE, na.rm = TRUE),
                   mean_Lat = mean(LATITUDE, na.rm = TRUE),
                   RELEASE = sum(TOTAL_RELEASES, na.rm = TRUE),
                   REUSE = sum(TOTAL_REUSE, na.rm = TRUE))

avgWithoutLongLat2016 <-avgLongLat2016 %>%
  dplyr::filter(!(ST %in% c('AK','AS','GU','MP','PR','VI','HI','DC')))

#other way

titleUSA2016 <- paste()
pUSA2016 = ggmap(get_googlemap(center=c(lon = -95.71289, lat =  37.09024), scale=2, zoom=4,format = c("png8")))

pUSA2016 <- pUSA2016+ geom_scatterpie(aes(x=mean_Long, y=mean_Lat),
                        data=avgWithoutLongLat2016, size = 0.5,cols=c('RELEASE','REUSE'), color=NA, alpha=.8)+ggtitle("Map Showing each State's Total Release And Total Reuse in Pie(2016)")
  #pUSA2016 <- pUSA2016

#########################PLOTTING PIE CHART for EACH STATE 2006 on MAP###################
avgLongLat2006<-filterPound2006 %>% 
  dplyr::group_by(ST) %>% 
  dplyr::summarize(mean_Long = mean(LONGITUDE, na.rm = TRUE),
                   mean_Lat = mean(LATITUDE, na.rm = TRUE),
                   RELEASE = sum(TOTAL_RELEASES, na.rm = TRUE),
                   REUSE = sum(TOTAL_REUSE, na.rm = TRUE))

avgWithoutLongLat2006 <-avgLongLat2006 %>%
  dplyr::filter(!(ST %in% c('AK','AS','GU','MP','PR','VI','HI','DC')))

#other way
#usa_center = as.numeric(geocode("United States"))
pUSA2006 = ggmap(get_googlemap(c(lon = -95.71289, lat =  37.09024), scale=2, zoom=4,format = c("png8")))
pUSA2006 <- pUSA2006+ geom_scatterpie(aes(x=mean_Long, y=mean_Lat),
                              data=avgWithoutLongLat2006, size = 0.5,cols=c('RELEASE','REUSE'), color=NA, alpha=.8)+ggtitle("Map Showing each State's Total Release And Total Reuse in Pie (2006)")
```

```{r}
pUSA2016

```

This map gives the overall picture of industrial facilities of each of the state of the United States in 2016. As can be seen in the map, most of the states in the eastern side of the country are able to reuse the chemical wastes that they are generating. The reuse is either recycling the production wastes that they generate or can be energy recovery of the produced wastes or treatment of the waste.Alaska's industrial facilities are the ones which are reutilising a very small proportion of the produced waste i.e. 1% of the waste that they are generating.So, Alaska is the one which is doing least reuse of the produced waste.(P.S. : Alaska is not in the map).

```{r}
pUSA2006
```

This map gives the overall picture of industrial facilities of each of the state of the United States in 2006. As can be seen in the map, the pie's are more pink than that of pie's of 2016.Alaska's industrial facilities are the ones which are reutilising a very small proportion of the produced waste i.e. 0.1% of the waste that they are generating.So, Alaska is the one which is doing least reuse of the produced waste.(P.S. : Alaska is not in the map).

                              
```{r, Overall maps}
dfRelease2016 <- aggregate(cbind(TOTAL_RELEASES,TOTAL_RECYLE,TOTAL_RECOVERY,TOTAl_TREATMENT,TOTAL_REUSE,X5.1_FUGITIVE_AIR+ X5.2_STACK_AIR,X5.3_WATER,PROD._WASTE_.8.1_THRU_8.7.) ~ ST , data = filterPound2016, FUN = sum)
dfRelease2006 <- aggregate(cbind(TOTAL_RELEASES,TOTAL_RECYLE,TOTAL_RECOVERY,TOTAl_TREATMENT,TOTAL_REUSE,X5.1_FUGITIVE_AIR+ X5.2_STACK_AIR,X5.3_WATER,PROD._WASTE_.8.1_THRU_8.7.) ~ ST , data = filterPound2006, FUN = sum)

dfRelease2016 <- dfRelease2016%>%
                 dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                        perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2),
                        perCentRecovery=round(TOTAL_RECOVERY/sum(TOTAL_RECOVERY)*100, 2),
                        perCentRecycle=round(TOTAL_RECYLE/sum(TOTAL_RECYLE)*100, 2),
                        perCentTreatment=round(TOTAl_TREATMENT/sum(TOTAl_TREATMENT)*100, 2))

dfRelease2006 <- dfRelease2006%>%
                 dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                        perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2),
                        perCentRecovery=round(TOTAL_RECOVERY/sum(TOTAL_RECOVERY)*100, 2),
                        perCentRecycle=round(TOTAL_RECYLE/sum(TOTAL_RECYLE)*100, 2),
                        perCentTreatment=round(TOTAl_TREATMENT/sum(TOTAl_TREATMENT)*100, 2))
  
#x is 2016 y is 2006  
mergeDfRelease <- merge(dfRelease2016,dfRelease2006, by ="ST")
mergeDfRelease <- mergeDfRelease%>%
                  mutate(perCentReleaseChange=round(((TOTAL_RELEASES.x -  TOTAL_RELEASES.y)/TOTAL_RELEASES.y)*100, 2),
                  perCentReuseChange=round(((TOTAL_REUSE.x - TOTAL_REUSE.y)/TOTAL_REUSE.y)*100, 2),
                  perCentRecoveryChange=round(((TOTAL_RECOVERY.x - TOTAL_RECOVERY.y)/TOTAL_RECOVERY.y)*100, 2),
                  perCentRecycleChange=round(((TOTAL_RECYLE.x - TOTAL_RECYLE.y)/TOTAL_RECYLE.y)*100, 2),
                  perCentTreatmentChange=round(((TOTAl_TREATMENT.x - TOTAl_TREATMENT.y)/TOTAl_TREATMENT.y)*100, 2))
```

```{r, Overall maps1,include=FALSE}
# to print total release on map calculating that value
# to print total release on map calculating that value
totalRelease2016 <- sum(dfRelease2016$TOTAL_RELEASES)
totalRelease2006 <- sum(dfRelease2006$TOTAL_RELEASES)

totalReuse2016 <- sum(dfRelease2016$TOTAL_REUSE)
totalReuse2006 <- sum(dfRelease2006$TOTAL_REUSE)

totalAirRelease2016 <- sum(dfRelease2016$V6)
totalAirRelease2006 <- sum(dfRelease2006$V6)

totalWaterRelease2016 <- sum(dfRelease2016$X5.3_WATER)
totalWaterRelease2006 <- sum(dfRelease2006$X5.3_WATER)

totalOtherRelease2016 <- totalRelease2016 - (totalAirRelease2016+totalWaterRelease2016)
totalOtherRelease2006 <- totalRelease2006 - (totalAirRelease2006+totalWaterRelease2006)

totalRecyle2016 <- sum(dfRelease2016$TOTAL_RECYLE)
totalRecyle2006 <- sum(dfRelease2006$TOTAL_RECYLE)

totalRecovery2016 <- sum(dfRelease2016$TOTAL_RECOVERY)
totalRecovery2006 <- sum(dfRelease2006$TOTAL_RECOVERY)

totalTreatment2016 <- sum(dfRelease2016$TOTAl_TREATMENT)
totalTreatment2006 <- sum(dfRelease2006$TOTAl_TREATMENT)

dfRelease2016$hover <- with(dfRelease2016, paste(ST))
dfRelease2006$hover <- with(dfRelease2006, paste(ST))

# give state boundaries a white border
l <- list(color = toRGB("white"), width = 2)
# specify some map projection/options
g <- list(
  scope = 'usa',
  projection = list(type = 'albers usa'),
  showlakes = TRUE,
  lakecolor = toRGB('white')
)

limitmaxRelease2016 <- max(dfRelease2016$TOTAL_RELEASES)
limitmaxRelease2006 <- max(dfRelease2006$TOTAL_RELEASES)
#2016 total release by each state 
p2016Release <- plot_geo(dfRelease2016, locationmode = 'USA-states') %>%
  add_trace(
    z = ~TOTAL_RELEASES, text = ~hover, locations = ~ST, 
    color = ~TOTAL_RELEASES, colors = 'OrRd', name = "Total Release"
  ) %>%
  colorbar(title = "in Pounds",limits = c(0,limitmaxRelease2016)) %>%
  # need to add total release value in title i.e totalRelease2016$TOTAL_RELEASES[2]
  layout(
    title = "2016 US Toxic Release by State<br>(Hover for breakdown)",
    geo = g
  )
#p2016Release

#2006 total release by each state
p2006Release <- plot_geo(dfRelease2006, locationmode = 'USA-states') %>%
  add_trace(
    z = ~TOTAL_RELEASES, text = ~hover, locations = ~ST,name = "Total Release",
    color = ~TOTAL_RELEASES, colors = 'OrRd',showscale= FALSE
  ) %>%
  colorbar(title = "in Pounds (2006)",limits = c(0,limitmaxRelease2016)) %>%
  # need to add total release value in title i.e totalRelease2006$TOTAL_RELEASES[2]
  layout(
    title = 'US Toxic Release by State <br>(Hover for breakdown)',
    geo = g
  )
#p2006Release
```

```{r,state ind 2016, include=FALSE}
stateInd2016 <- aggregate(TOTAL_RELEASES ~ ST+INDUSTRY_SECTOR  , data = filterPound2016, FUN = sum)

pstateInd2016<- plot_ly(stateInd2016, x = ~ST, y = ~TOTAL_RELEASES, color = ~INDUSTRY_SECTOR,name = '2016', type = 'scatter', mode = 'line+markers', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2)))%>%
  layout(title = 'Total Release By Each Industry in each State(2016)')
```

```{r,state,warning=FALSE,message=FALSE}
pstateInd2016
```

The graph shows the chemical wastes released by each of the industry sectors in each of the state.Further analysis for the unusual points has been done.


```{r,Plot of total Release}
px <- subplot(p2016Release,p2006Release, nrows = 2)
px %>% layout(annotations = list(
  list(x = 0.05 , y = 0.85, text = "2016", showarrow = F, xref='paper', yref='paper'),
  #list(x = 0, y = 1, showlegend = FALSE),
  list(x = 0.05 , y = 0.25, text = "2006", showarrow = F, xref='paper', yref='paper'))
)
```


The above graphs show the comparison of toxic chemical releases of each state's industrial facilities in 2006 and 2016.It can be clearly seen that Alaska has the darkest color both in 2006 and 2016 that means Alaska's industrial facilities are releasing toxic chemicals the maximum.The toxic release has gone from 668.5 Million in 2006 to 833.8 Million in 2016 i.e. 24% rise. While a significant increase in toxic release can be seen in Utah for which there is 154% increase in toxic release from 187.4 Million to 476 Million and also for Nevada for which it has gone from 174.3 Million to 316.8 Million i.e. an increase of 81.8% and for North Dakota, though the amount of waste is less significant but the change in release is 105% i.e. from 20.7 Million to 42.6 Million.On the other side, a siginicant decrease in the release of toxic chemicals by industrial facilities can be seen in the state of Ohio from 273 Million to 104 Million i.e. 61% decrease.Though the amount of release is less significant but a significant decrease is observed for North hamshire from 4 Million to 275k i.e. 93% decrease.Also, Maryland and Delaware have a decrease of 76% and 68%.


```{r,Code of total Reuse,include=FALSE}
limitmaxReuse2016 <- max(dfRelease2016$TOTAL_REUSE)
limitmaxReuse2006 <- max(dfRelease2006$TOTAL_REUSE)
p2016Reuse <- plot_geo(dfRelease2016, locationmode = 'USA-states') %>%
  add_trace(
    z = ~TOTAL_REUSE, text = ~hover, locations = ~ST,
    color = ~TOTAL_REUSE, colors = 'YlGn'
  ) %>%
  colorbar(title = "in Pounds",limits = c(0,limitmaxReuse2016)) %>%
  # need to add total release value in title i.e totalRelease2016$TOTAL_RELEASES[2]
  layout(
    title = "2016 US Toxic Reuse by State<br>(Hover for breakdown)",
    geo = g
  )
#p2016Reuse

#2006 total release by each state
p2006Reuse <- plot_geo(dfRelease2006, locationmode = 'USA-states') %>%
  add_trace(
    z = ~TOTAL_REUSE, text = ~hover, locations = ~ST,
    color = ~TOTAL_REUSE, colors = 'YlGn',showscale= FALSE
  ) %>%
  colorbar(title = "in Pounds (2006)",limits = c(0,limitmaxReuse2016)) %>%
  # need to add total release value in title i.e totalRelease2006$TOTAL_RELEASES[2]
  layout(
    title = 'US Toxic Reuse by State <br>(Hover for breakdown)',
    geo = g
  )
#p2006Reuse
pReuse <- subplot(p2016Reuse,p2006Reuse, nrows = 2)


```


```{r,Plot of total Reuse}
pReuse %>% layout(annotations = list(
  list(x = 0.15 , y = 0.85, text = "2016", showarrow = F, xref='paper', yref='paper'),
  #list(x = 0, y = 1, showlegend = FALSE),
  list(x = 0.15 , y = 0.25, text = "2006", showarrow = F, xref='paper', yref='paper'))
)
```


The above graphs show the comparison of Reuse(it may be by recylcing the produced toxic chemical waste or by energy recovery of waste i.e. conversion of non-recyclable waste materials into useable heat, electricity, or fuel by a variety of processes like combustion, gasification etc or by treatment of the wasteproduced) of each state's industrial facilities in 2006 and 2016.It can be clearly seen that Texa's has the darkest color both in 2006 and 2016 that means Texa's industrial facilities are reutilising toxic chemicals the maximum. The reuse of toxic chemicals has gone from 3.56 billion in 2006 to 3.88 billion in 2016 i.e. 9% rise.Also, Louisiana's industrial facilities total reuse is in the range of 2 Billion and has gone up by 17.52% from 2006 to 2016.While the maximun increase from 2006 to 2016 in total reuse of toxic chemical waste is in Utah for which there is 713% increase from 64.5 Million to 525.18 Million and also for Pennsylvania for which it has gone from 761.3 Million to 4 Billion i.e. an increase of 424% and for Delaware though the quantity of waste recylced is less significant but the change in reuse is 411% i.e. from 78.3 Million to 400 Million.On the other side, a significant decrease in the reuse of toxic chemicals by industrial facilities can be seen in Alaska from 69 Million to 1.5 Million i.e. 98% decrease.Also, a significant decrease is observed for Connecticut from 72.6 Million to 37.23 Million i.e. 48% decrease and for Arizona which has a decrease of 42%.

```{r, prod waste, total release, include=FALSE}
p2016_ProdWasteReleaseCor <- plot_ly(data = dfRelease2016, x = ~PROD._WASTE_.8.1_THRU_8.7., y = ~TOTAL_RELEASES, mode = "markers",type = "scatter",text = ~paste("State :", ST, "<br>")
                                     ,marker = list(opacity = 0.5,size = 10,color = 'rgba(255, 182, 193, .9)',line = list(color = 'rgba(152, 0, 0, .8)',
                                                                                                            width = 2))) %>%                                                                                                                                                                                             
  layout(title = 'Total Production Vs Total Release(2016)',
         xaxis = list(title = "Total Production Waste",tickfont = list( size = 14,color = 'rgb(107, 102, 107)')),
         yaxis = list(title = 'Total Release',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),
                      tickfont = list(size = 14,color = 'rgb(107, 107, 107)')))

```

```{r}
p2016_ProdWasteReleaseCor
```
The graph depicts the Total production waste and Total release by each of the states.The states with uncommon behaviour have been further analysed.

```{r , State Wise Release,reuse, count data Functions,include=FALSE}
facilityReleaseData2016<-filterPound2016 %>% 
                          dplyr::group_by(TRI_FACILITY_ID) %>% 
                          dplyr::summarise(total_release = sum(TOTAL_RELEASES),total_reuse =  sum(TOTAL_REUSE),total_productionWaste = sum(PROD._WASTE_.8.1_THRU_8.7.))

facilityData2016 <- filterPound2016[!duplicated(filterPound2016[,c('TRI_FACILITY_ID')]),]

facilityData2016 <- subset(facilityData2016, select = c(LONGITUDE,LATITUDE,TRI_FACILITY_ID,FACILITY_NAME,FEDERAL_FACILITY,INDUSTRY_SECTOR,STREET_ADDRESS,CITY,ST))#, unique(FACILITY_NAME) & ST == 'NH' | ST=='AK' )

mergeFacilityData2k16 <- merge(facilityReleaseData2016, facilityData2016, by="TRI_FACILITY_ID")


###################2006
facilityReleaseData2006<-filterPound2006 %>% 
  dplyr::group_by(TRI_FACILITY_ID) %>% 
  dplyr::summarise(total_release = sum(TOTAL_RELEASES),total_reuse = sum(TOTAL_REUSE),total_productionWaste = sum(PROD._WASTE_.8.1_THRU_8.7.))

facilityData2006 <- filterPound2006[!duplicated(filterPound2006[,c('TRI_FACILITY_ID')]),]

facilityData2006 <- subset(facilityData2006, select = c(LONGITUDE,LATITUDE,TRI_FACILITY_ID,FACILITY_NAME,FEDERAL_FACILITY,INDUSTRY_SECTOR,STREET_ADDRESS,CITY,ST))#, unique(FACILITY_NAME) & ST == 'NH' | ST=='AK' )

mergeFacilityData2k06 <- merge(facilityReleaseData2006, facilityData2006, by="TRI_FACILITY_ID")



industryCntSt2016 <- mergeFacilityData2k16 %>%
                      group_by(ST,INDUSTRY_SECTOR)%>%
                      summarise(count=n())

industryCntSt2006 <- mergeFacilityData2k06 %>%
                      group_by(ST,INDUSTRY_SECTOR)%>%
                      summarise(count=n())

mergeIndCnt <- dplyr::full_join(industryCntSt2016, industryCntSt2006, by=c("ST","INDUSTRY_SECTOR"))


getBarPlotIndCnt2006_2016 <- function( usState ){
  title_Ind_City <- paste('Total Industrial Facilities in',usState ,' in 2006 and 2016')
  return(title_Ind_City)
}

barPlotindCnt2006_2016 <- function(mergedData, usState ){
  filterStateData <- mergedData%>%
                    dplyr::filter(ST == usState)
  p2006_2016_State_Ind<- plot_ly(filterStateData, x = ~INDUSTRY_SECTOR, y = ~count.y, name = '2006', type = 'bar', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
    add_trace(y = ~count.x, name = '2016', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
    
    layout(title = getBarPlotIndCnt2006_2016(usState),
           xaxis = list(
             title = "",
             tickfont = list(
               size = 14,
               color = 'rgb(107, 107, 107)')),
           yaxis = list(
             title = 'Number of Indutrial Facilities',
             titlefont = list(
               size = 16,
               color = 'rgb(107, 107, 107)'),
             tickfont = list(
               size = 14,
               color = 'rgb(107, 107, 107)')),
           #legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
           barmode = 'group', bargap = 0.15)
  
  return(p2006_2016_State_Ind)
}

getBarPlotStateTitleReuse2006_2016 <- function( usState ){
  title_Reuse_City <- paste('Total Reuse by',usState ,'Industrial Facilities in 2006 and 2016')
  return(title_Reuse_City)
}
getBarPlotStateTitleRelease2006_2016 <- function( usState ){
  title_Release_City <- paste('Total Release by',usState ,'Industrial Facilities in 2006 and 2016')
  return(title_Release_City)
}

barPlotReleaseBw2006_2016 <- function(mergedData, usState ){
p2006_2016_State_Release <- plot_ly(mergedData, x = ~INDUSTRY_SECTOR, y = ~TOTAL_RELEASES.y, name = '2006', type = 'bar', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
    add_trace(y = ~TOTAL_RELEASES.x, name = '2016', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
    layout(title = getBarPlotStateTitleRelease2006_2016(usState),
           xaxis = list(
             title = "",
             tickfont = list(
               size = 14,
               color = 'rgb(107, 107, 107)')),
           yaxis = list(
             title = 'Release (in Pounds)',
             titlefont = list(
               size = 16,
               color = 'rgb(107, 107, 107)'),
             tickfont = list(
               size = 14,
               color = 'rgb(107, 107, 107)')),
           #legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
           barmode = 'group', bargap = 0.15)

  return(p2006_2016_State_Release)
}

barPlotReuseBw2006_2016 <- function(mergedData, usState ){
p2006_2016_State_Ruse <- plot_ly(mergedData, x = ~INDUSTRY_SECTOR, y = ~TOTAL_REUSE.y, name = '2006', type = 'bar', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
  add_trace(y = ~TOTAL_REUSE.x, name = '2016', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
  
  layout(title = getBarPlotStateTitleReuse2006_2016(usState),
         xaxis = list(
           title = "",
           tickfont = list(
             size = 14,
             color = 'rgb(107, 107, 107)')),
         yaxis = list(
           title = 'Reuse (in Pounds)',
           titlefont = list(
             size = 16,
             color = 'rgb(107, 107, 107)'),
           tickfont = list(
             size = 14,
             color = 'rgb(107, 107, 107)')),
         #legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'group', bargap = 0.15)

return(p2006_2016_State_Ruse)
}
```


```{r,Alaska , warning=FALSE,include=FALSE}
indAK2006 <- filterPound2006 %>% 
  dplyr::filter( ST == "AK") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.) %>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES),
                   TOTAL_REUSE = sum(TOTAL_REUSE), 
                   TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))

indAK2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "AK") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.)%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES),
                   TOTAL_REUSE = sum(TOTAL_REUSE),
                   TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))


mergedAKByIndustry <- dplyr::full_join(indAK2016, indAK2006, by="INDUSTRY_SECTOR") 

```

```{r,Alaska1 , include=FALSE, warning=FALSE}
p2006_2016_AK_Release <- barPlotReleaseBw2006_2016(mergedAKByIndustry,"AK")
p2006_2016_AK_Reuse <- barPlotReuseBw2006_2016(mergedAKByIndustry,"AK")
p2006_2016_AK_IndCnt <- barPlotindCnt2006_2016(mergeIndCnt,"AK")
```


```{r}
subplot(p2006_2016_AK_Release,p2006_2016_AK_Reuse,p2006_2016_AK_IndCnt, nrows = 3, shareX = TRUE)%>% layout(annotations = list(
 list(x = -0.11 , y = 0.90, text = "Total <br> Release", showarrow = F, xref='paper', yref='paper'),
  list(x = -0.11 , y = 0.5, text = "Total <br> Reuse", showarrow = F, xref='paper', yref='paper'),
 list(x = -0.11 , y = 0.12, text = "Total <br> Industries", showarrow = F, xref='paper', yref='paper')),title = 'Analysis of Alaska'
)
```



So, it can be clearly seen from the bar graphs that the increase in the toxic chemical release by industrial facilities of Alaska is due to the Metal mining Industrial Facilities. While in 2006 as well, Alaska's industrial facilities were releasing the maximum toxic release and it was due to metal mining industries and in 2016, it's still due to metal mining industrial facilities.
Overall the number of industrial facilities have decreased in Alaska but the number of Metal Mining Industrial facilities which release the maximum waste remains the same.


```{r,Utah , include=FALSE, warning=FALSE}
indUT2006 <- filterPound2006 %>% 
  dplyr::filter( ST == "UT") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.) %>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE), TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indUT2006$TOTAL_REUSE[indUT2006$TOTAL_REUSE<0] <- 0

indUT2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "UT") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.)%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE),  TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indUT2016$TOTAL_REUSE[indUT2016$TOTAL_REUSE<0] <- 0

mergedUTByIndustry <- dplyr::full_join(indUT2016, indUT2006, by="INDUSTRY_SECTOR") 

p2006_2016_UT_Release <- barPlotReleaseBw2006_2016(mergedUTByIndustry,"UT")
p2006_2016_UT_Reuse <- barPlotReuseBw2006_2016(mergedUTByIndustry,"UT")
p2006_2016_UT_IndCnt <- barPlotindCnt2006_2016(mergeIndCnt,"UT")
```


```{r,warning=FALSE,message=FALSE}
subplot(p2006_2016_UT_Release,p2006_2016_UT_Reuse,p2006_2016_UT_IndCnt, nrows = 3, shareX = TRUE)%>% layout(annotations = list(
 list(x = -0.11 , y = 0.90, text = "Total <br> Release", showarrow = F, xref='paper', yref='paper'),
  list(x = -0.11 , y = 0.5, text = "Total <br> Reuse", showarrow = F, xref='paper', yref='paper'),
 list(x = -0.11 , y = 0.12, text = "Total <br> Industries", showarrow = F, xref='paper', yref='paper')),title = 'Analysis of Utah'
)
```


As it can be clearly seen from the bar graphs that the increase in the chemical release by industrial facilities of Utah from 2006 to 2016 is mainly due to increase in release by Electric Utilities industry from 5 Million to 206 Million.Also, a significant increase in the release by Metal Mining industry and Primary Metals industry can be seen.
And increase in total Reuse can be significantly seen in Primary Metals industry and Petroleum Industry while the number of industrial facilities is more or less the same.



```{r,Nevada increase, include=FALSE}
indNV2006 <- filterPound2006 %>% 
  dplyr::filter( ST == "NV") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.) %>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE), TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indNV2006$TOTAL_REUSE[indNV2006$TOTAL_REUSE<0] <- 0

indNV2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "NV") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.)%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE),  TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indNV2016$TOTAL_REUSE[indNV2016$TOTAL_REUSE<0] <- 0

mergedNVByIndustry <- dplyr::full_join(indNV2016, indNV2006, by="INDUSTRY_SECTOR") 

p2006_2016_NV_Release <- barPlotReleaseBw2006_2016(mergedNVByIndustry,"NV")
p2006_2016_NV_Reuse <- barPlotReuseBw2006_2016(mergedNVByIndustry,"NV")
p2006_2016_NV_IndCnt <- barPlotindCnt2006_2016(mergeIndCnt,"NV")
```

```{r}
subplot(p2006_2016_NV_Release,p2006_2016_NV_Reuse,p2006_2016_NV_IndCnt, nrows = 3, shareX = TRUE)%>% layout(annotations = list(
 list(x = -0.11 , y = 0.90, text = "Total <br> Release", showarrow = F, xref='paper', yref='paper'),
  list(x = -0.11 , y = 0.5, text = "Total <br> Reuse", showarrow = F, xref='paper', yref='paper'),
 list(x = -0.11 , y = 0.12, text = "Total <br> Industries", showarrow = F, xref='paper', yref='paper')),title = 'Analysis of Nevada'
)
```


As can be clearly seen from the bar graphs, that large increase in toxic chemical release by industrial facilities of Nevada is due to a siginificant increase in the release by Metal Mining industrial facilities in the state and decrease in total reuse of chemical wastes by industrial facilities in almost all the sectors in the state except for Chemical industrial facilities.While the number of industrial facilities have increased in other sectors



```{r,Ohio decrease, include=FALSE,warning=FALSE}
indOH2006 <- filterPound2006 %>% 
  dplyr::filter( ST == "OH") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.) %>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE), TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indOH2006$TOTAL_REUSE[indOH2006$TOTAL_REUSE<0] <- 0

indOH2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "OH") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.)%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE),  TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indOH2016$TOTAL_REUSE[indOH2016$TOTAL_REUSE<0] <- 0

mergedOHByIndustry <- dplyr::full_join(indOH2016, indOH2006, by="INDUSTRY_SECTOR") 

p2006_2016_OH_Release <- barPlotReleaseBw2006_2016(mergedOHByIndustry,"OH")
p2006_2016_OH_Reuse <- barPlotReuseBw2006_2016(mergedOHByIndustry,"OH")
p2006_2016_OH_IndCnt <- barPlotindCnt2006_2016(mergeIndCnt,"OH")
```


```{r}
subplot(p2006_2016_OH_Release,p2006_2016_OH_Reuse,p2006_2016_OH_IndCnt, nrows = 3, shareX = TRUE)%>% layout(annotations = list(
 list(x = -0.11 , y = 0.90, text = "Total <br> Release", showarrow = F, xref='paper', yref='paper'),
  list(x = -0.11 , y = 0.5, text = "Total <br> Reuse", showarrow = F, xref='paper', yref='paper'),
 list(x = -0.11 , y = 0.12, text = "Total <br> Industries", showarrow = F, xref='paper', yref='paper')),title = 'Analysis of Ohio'
)
```


So, As can be clearly seen from the bar graph that the significant decrease in total chemical release in Ohio is due to decrease in total chemical release by almost every industry sector in Ohio with significant decrease in electric Utilities, Hazardous waste and primary metals industry.
and correspondingly an increase in total reuse by the facilities of the above sectors.While the number of industries remaining the same more or less.



```{r,Texas decrease, include=FALSE,warning=FALSE}
indTX2006 <- filterPound2006 %>% 
  dplyr::filter( ST == "TX") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.) %>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE), TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indTX2006$TOTAL_REUSE[indTX2006$TOTAL_REUSE<0] <- 0

indTX2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "TX") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.)%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE),  TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indTX2016$TOTAL_REUSE[indTX2016$TOTAL_REUSE<0] <- 0

mergedTXByIndustry <- dplyr::full_join(indTX2016, indTX2006, by="INDUSTRY_SECTOR") 

p2006_2016_TX_Release <- barPlotReleaseBw2006_2016(mergedTXByIndustry,"TX")
p2006_2016_TX_Reuse <- barPlotReuseBw2006_2016(mergedTXByIndustry,"TX")
p2006_2016_TX_IndCnt <- barPlotindCnt2006_2016(mergeIndCnt,"TX")
```


```{r,warning=FALSE,message=FALSE}
subplot(p2006_2016_TX_Release,p2006_2016_TX_Reuse,p2006_2016_TX_IndCnt, nrows = 3, shareX = TRUE)%>% layout(annotations = list(
 list(x = -0.11 , y = 0.90, text = "Total <br> Release", showarrow = F, xref='paper', yref='paper'),
  list(x = -0.11 , y = 0.5, text = "Total <br> Reuse", showarrow = F, xref='paper', yref='paper'),
 list(x = -0.11 , y = 0.12, text = "Total <br> Industries", showarrow = F, xref='paper', yref='paper')),title = 'Analysis of Texas'
)
```



So, As can be clearly seen from the bar graphs that there is an increase in chemical release by the Chemical and Hazardous waste Industry and the major proportion of waste that is reused is by chemical industrial facilities (around 3 Billion), which makes Texas the most reusing state.Also a significant increase in the number of chemical and other industrial facilities can be seen 
and correspondingly a little increase in total reuse by the facilities of the above sectors.



```{r,Louisiana decrease, include=FALSE}
indLA2006 <- filterPound2006 %>% 
  dplyr::filter( ST == "LA") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.) %>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE), TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indLA2006$TOTAL_REUSE[indLA2006$TOTAL_REUSE<0] <- 0

indLA2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "LA") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.)%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE),  TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indLA2016$TOTAL_REUSE[indLA2016$TOTAL_REUSE<0] <- 0

mergedLAByIndustry <- dplyr::full_join(indLA2016, indLA2006, by="INDUSTRY_SECTOR") 

p2006_2016_LA_Release <- barPlotReleaseBw2006_2016(mergedLAByIndustry,"LA")
p2006_2016_LA_Reuse <- barPlotReuseBw2006_2016(mergedLAByIndustry,"LA")
p2006_2016_LA_IndCnt <- barPlotindCnt2006_2016(mergeIndCnt,"LA")
```


```{r}
subplot(p2006_2016_LA_Release,p2006_2016_LA_Reuse,p2006_2016_LA_IndCnt, nrows = 3, shareX = TRUE)%>% layout(annotations = list(
 list(x = -0.11 , y = 0.90, text = "Total <br> Release", showarrow = F, xref='paper', yref='paper'),
  list(x = -0.11 , y = 0.5, text = "Total <br> Reuse", showarrow = F, xref='paper', yref='paper'),
 list(x = -0.11 , y = 0.12, text = "Total <br> Industries", showarrow = F, xref='paper', yref='paper')),title = 'Analysis of Louisiana'
)
```



As can be seen from the bar graphs, the increase in total reuse of the waste by the industrial facilities of Louisiana is due to the chemical industrial Facilities.If we compare Texas and Louisiana, because of more chemical industrial facilities in Texas, the amount of reuse in Texas is much larger but on the other hand the release of toxic chemicals has risen more in Louisiana than in Texas, which means chemical industrial facilities of Texas are reusing the chemical waste much more efficiently than that of Louisiana.



```{r,Pennysilvania decrease, include=FALSE}
indPA2006 <- filterPound2006 %>% 
  dplyr::filter( ST == "PA") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.) %>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE), TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indPA2006$TOTAL_REUSE[indPA2006$TOTAL_REUSE<0] <- 0

indPA2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "PA") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,PROD._WASTE_.8.1_THRU_8.7.)%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>%
  dplyr::summarise(TOTAL_RELEASES = sum(TOTAL_RELEASES), TOTAL_REUSE = sum(TOTAL_REUSE),  TOTAL_PROD_WASTE = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCentRelease=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2),
                perCentReuse=round(TOTAL_REUSE/sum(TOTAL_REUSE)*100, 2))
indPA2016$TOTAL_REUSE[indPA2016$TOTAL_REUSE<0] <- 0

mergedPAByIndustry <- dplyr::full_join(indPA2016, indPA2006, by="INDUSTRY_SECTOR") 

p2006_2016_PA_Release <- barPlotReleaseBw2006_2016(mergedPAByIndustry,"PA")
p2006_2016_PA_Reuse <- barPlotReuseBw2006_2016(mergedPAByIndustry,"PA")
p2006_2016_PA_IndCnt <- barPlotindCnt2006_2016(mergeIndCnt,"PA")
```


```{r}
subplot(p2006_2016_PA_Release,p2006_2016_PA_Reuse,p2006_2016_PA_IndCnt, nrows = 3, shareX = TRUE)%>% layout(annotations = list(
 list(x = -0.11 , y = 0.90, text = "Total <br> Release", showarrow = F, xref='paper', yref='paper'),
  list(x = -0.11 , y = 0.5, text = "Total <br> Reuse", showarrow = F, xref='paper', yref='paper'),
 list(x = -0.11 , y = 0.12, text = "Total <br> Industries", showarrow = F, xref='paper', yref='paper')),title = 'Analysis of Pennsylvania'
)
```



In Pennsylvania, the main reason in the increase of the Reuse of waste by industrial facilities can be attributed to the chemical industries as it can be clearly seen, the reuse of production waste by chemical industries has risen from 215 Million to 3.5 Billion pounds.Also, the decrease of release can be seen in almost all the industy sectors in the state.

```{r,Carcinogenic map, include=FALSE}
carciogenicRelease2016 <- aggregate(TOTAL_RELEASES ~ ST+CARCINOGEN , data = filterPound2016, FUN = sum)

carciogenicRelease2016 <- carciogenicRelease2016%>% 
  dplyr::filter(CARCINOGEN == 'YES')
maxCarRelease2016 <- max(carciogenicRelease2016$TOTAL_RELEASES)

carciogenicRelease2006 <- aggregate(TOTAL_RELEASES ~ ST+CARCINOGEN , data = filterPound2006, FUN = sum)

carciogenicRelease2006 <- carciogenicRelease2006%>% 
  dplyr::filter(CARCINOGEN == 'YES')
maxCarRelease2006 <- max(carciogenicRelease2006$TOTAL_RELEASES)

carciogenicRelease2016$hover <- with(carciogenicRelease2016, paste(ST))
p2016_carcinogen <- plot_geo(carciogenicRelease2016, locationmode = 'USA-states') %>%
  add_trace(
    z = ~TOTAL_RELEASES, text = ~hover, locations = ~ST,
    color = ~TOTAL_RELEASES, colors = 'PuRd',showscale= FALSE
  ) %>%
  colorbar(title = "Millions Pound",limits = c(0,maxCarRelease2006)) %>%
  # need to add total release value in title i.e totalRelease2016$TOTAL_RELEASES[2]
  layout(
    title = "2016 US Carcinogenic Toxic Release by State<br>(Hover for breakdown)",
    geo = g
  )
#p2016_carcinogen
#########################################################2006

carciogenicRelease2006$hover <- with(carciogenicRelease2006, paste(ST))
p2006_carcinogen <- plot_geo(carciogenicRelease2006, locationmode = 'USA-states') %>%
  add_trace(
    z = ~TOTAL_RELEASES, text = ~hover, locations = ~ST,
    color = ~TOTAL_RELEASES, colors = 'PuRd'
  ) %>%
  colorbar(title = "Millions Pound",limits = c(0,maxCarRelease2006)) %>%
  # need to add total release value in title i.e totalRelease2016$TOTAL_RELEASES[2]
  layout(
    title = "US Carcinogenic Toxic Release by State<br>(Hover for breakdown)",
    geo = g
  )
```



```{r}
px <- subplot(p2016_carcinogen,p2006_carcinogen,nrows = 2)
px %>% layout(annotations = list(
  list(x = 0.05 , y = 0.85, text = "2016", showarrow = F, xref='paper', yref='paper'),
  #list(x = 0, y = 1, showlegend = FALSE),
  list(x = 0.05 , y = 0.25, text = "2006", showarrow = F, xref='paper', yref='paper'))
)
```


As it can be seen from the maps that Texas is the state whose industrial Facilities release the maximum Carcinogenic Chemicals followed by Louisiana.

```{r, texas pie carcinogenic, include=FALSE}
indTX2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "TX") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,CARCINOGEN,CHEMICAL)

sd <- indTX2016 %>%
      dplyr::filter(CARCINOGEN == 'YES' ) %>%
      dplyr::group_by(CHEMICAL)   %>%
      dplyr::summarise(Total_Release = sum(TOTAL_RELEASES))%>%
      ungroup%>%
      dplyr::mutate(perCent=round(Total_Release/sum(Total_Release)*100, 2))%>%
      dplyr::arrange( desc(perCent))
aggregateTXCarciIndstry2016 <- aggregate(TOTAL_RELEASES~INDUSTRY_SECTOR+CARCINOGEN, data = indTX2016, FUN = sum)

aggregateTXCarciIndstry2016 <- aggregateTXCarciIndstry2016%>% 
  dplyr::filter(CARCINOGEN == 'YES')

p_TX_carci2016 <- plot_ly(aggregateTXCarciIndstry2016, labels = ~INDUSTRY_SECTOR, values = ~TOTAL_RELEASES, type = 'pie',
             textposition = 'outside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             colors = 'Dark2',
             text = ~paste(round((TOTAL_RELEASES)/1000000,2), 'M pounds'),
             marker = list(line = list(color = '#FFFFFF', width = 1)),
             showlegend = FALSE) %>%
  layout(title = 'Texas CARCINOGENIC RELEASE by Industry Categories in 2016',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```


```{r}
p_TX_carci2016
```


As can be seen from the pie chart, the maximum release of carcinogenic chemicals is done by Chemical Industrial Facilities in Texas followed by Other.


```{r,Lousisna, include=FALSE}
indLA2016 <- filterPound2016 %>% 
  dplyr::filter( ST == "LA") %>%
  dplyr::select(INDUSTRY_SECTOR, TOTAL_RELEASES,TOTAL_REUSE,CARCINOGEN)


aggregateLACarciIndstry2016 <- aggregate(TOTAL_RELEASES~INDUSTRY_SECTOR+CARCINOGEN, data = indLA2016, FUN = sum)

aggregateLACarciIndstry2016 <- aggregateLACarciIndstry2016%>% 
  dplyr::filter(CARCINOGEN == 'YES')

p_LA_carci2016 <- plot_ly(aggregateLACarciIndstry2016, labels = ~INDUSTRY_SECTOR, values = ~TOTAL_RELEASES, type = 'pie',
                          textposition = 'inside',
                          textinfo = 'label+percent',
                          insidetextfont = list(color = '#FFFFFF'),
                          hoverinfo = 'text',
                          colors = 'Dark2',
                          text = ~paste(round((TOTAL_RELEASES)/2240,2), ' tonnes'),
                          marker = list(line = list(color = '#FFFFFF', width = 1)),
                          showlegend = FALSE) %>%
  layout(title = 'Louisiana CARCINOGENIC RELEASE by Industry Categories in 2016',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

```

```{r}
p_LA_carci2016
```


Again in Louisiana, its the Chemical industrial facilities which are reponsible for the most carcinogenic release.

The carcinogenic chemicals released by Chemicals Industry are as Follow:

 + ACRYLONITRILE
 + STYRENE
 + BENZENE
 + ACRYLAMIDE


##Industry Wise Analysis


```{r,no. of industry plotting,include=FALSE }

industryPlotData2016 <- mergeFacilityData2k16%>%
  dplyr::filter(!(ST %in% c('AK','HI')) &  LONGITUDE < 0 & !(is.na(mergeFacilityData2k16$LONGITUDE)) & !(is.na(mergeFacilityData2k16$LATITUDE)))

us <- map_data("state")
gg <- ggplot(data=industryPlotData2016,aes(x = LONGITUDE, y =LATITUDE))
gg <- gg + geom_polygon( data=us , aes(x=long, y=lat, group = group),colour="grey10", fill="white"  )
gg <- gg + geom_jitter(position = position_jitter(width = 0.3), aes(color = factor(INDUSTRY_SECTOR)), size = 1.5, alpha = .25)  + facet_wrap( ~ INDUSTRY_SECTOR, ncol=3)+ggtitle("Maps Showing the Distribution of Industrial Facilities throughout US(2016)")

```

```{r}
gg
```


The above map shows the distribution of different industry sectors throughout the United States in 2016.As can be clearly seen that most of the industry is located on the eastern side of the United States.Except for Metal Mining which can be seen more on the west side than east. Also, the coal industry is quite limited and can be seen at a few limited states in the map.Probably the reason fo rmost of the industrial facilities to be concentrated on the right side may be due to more population on the easters side. We will see it soon. 




```{r,pie chart of total Release plotting,include=FALSE}
totalProdWasteByIndustry2016 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE) ~ INDUSTRY_SECTOR , data = filterPound2016, FUN = sum)

totalProdWasteByIndustry2006 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE) ~ INDUSTRY_SECTOR , data = filterPound2006, FUN = sum)

#colors <- c('rgb(211,94,96)', 'rgb(128,133,133)', 'rgb(144,103,167)', 'rgb(171,104,87)', 'rgb(114,147,203)')

p2016_totalProdWaste <- plot_ly(totalProdWasteByIndustry2016, labels = ~INDUSTRY_SECTOR, values = ~PROD._WASTE_.8.1_THRU_8.7., type = 'pie',
             textposition = 'inside',
             textinfo = 'label+percent',
             insidetextfont = list(color = '#FFFFFF'),
             hoverinfo = 'text',
             text = ~paste(round((PROD._WASTE_.8.1_THRU_8.7.)/1000000000,2), ' billions lb'),
             marker = list(line = list(color = '#FFFFFF', width = 1)),
             showlegend = TRUE,alpha = 0.5) %>%
  layout(title = 'United States Production Waste by Industry Categories in 2016',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

#p2016_totalProdWaste

p2006_totalProdWaste <- plot_ly(totalProdWasteByIndustry2006, labels = ~INDUSTRY_SECTOR, values = ~PROD._WASTE_.8.1_THRU_8.7., type = 'pie',
                                textposition = 'inside',
                                textinfo = 'label+percent',
                                insidetextfont = list(color = '#FFFFFF'),
                                hoverinfo = 'text',
                                text = ~paste(round((PROD._WASTE_.8.1_THRU_8.7.)/1000000000,2), ' billions lb'),
                                marker = list(line = list(color = '#FFFFFF', width = 1)),
                                showlegend = FALSE) %>%
  layout(title = 'United States Production Waste by Industry Categories in 2006',
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

#p2006_totalProdWaste
```

```{r}
p2016_totalProdWaste
```

```{r}
p2006_totalProdWaste
```


These are the pie charts of the Total Production Waste by the different industry sectors in the year 2006 and 2016.it can be clearly seen that the maximum waste is generated by chemical industrial facilities both in 2006 and 2016 with an increase from 9.5 Billions in 2006 to 13.53 Billions in 2016.But as can be seen from Texas, Louisiana and Pennsylvania states, the chemical industrial facilities reuse most of the productiion waste they generate.At the second number, the most waste is generated by "Other" industrial facilities.Also a significant increase in Petroleum industry can be seen from 1 Billion in 2006 to 2.21 Billion in 2016.



```{r,bar chart of total Release, total reuse industry wis plotting,include=FALSE}

mergeDataInd20062016 <- dplyr::full_join(totalProdWasteByIndustry2016,totalProdWasteByIndustry2006, by="INDUSTRY_SECTOR" )%>%
                  mutate(perCentReleaseChange=round(((TOTAL_RELEASES.x-TOTAL_RELEASES.y)/TOTAL_RELEASES.y)*100, 2),
                  perCentReuseChange=round(((TOTAL_REUSE.x - TOTAL_REUSE.y)/TOTAL_REUSE.y)*100, 2))

p2006_2016_Ind_Ruse <- plot_ly(mergeDataInd20062016, x = ~INDUSTRY_SECTOR, y = ~TOTAL_REUSE.y, name = '2006', type = 'bar', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
  add_trace(y = ~TOTAL_REUSE.x, name = '2016', marker = list(line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
layout(title = 'Total Reuse By US Industries in 2006 and 2016',
         xaxis = list(
           title = "",
           tickfont = list(
             size = 14,
             color = 'rgb(107, 107, 107)')),
         yaxis = list(
           title = 'Pounds (Billions)',
           titlefont = list(
             size = 16,
             color = 'rgb(107, 107, 107)'),
           tickfont = list(
             size = 14,
             color = 'rgb(107, 107, 107)')),
         #legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'group', bargap = 0.15)



p2006_2016_Ind_Release <- plot_ly(mergeDataInd20062016, x = ~INDUSTRY_SECTOR, y = ~TOTAL_RELEASES.y, type = 'bar', name = '2006',
              marker = list(color = 'rgb(164, 244, 234)',line= list(color = 'rgba(237, 168, 211)', width = 2))) %>%
  add_trace(y = ~TOTAL_RELEASES.x, name = '2016' ,marker = list(color = 'rgb(14, 163, 144)',line= list(color = 'rgba(237, 168, 211)',width = 2))) %>%
  layout(title = 'Total Release By US Industries in 2006 and 2016',
         xaxis = list(
           title = "",
           tickfont = list(
             size = 14,
             color = 'rgb(107, 107, 107)')),
         yaxis = list(
           title = 'Pounds (Billions)',
           titlefont = list(
             size = 16,
             color = 'rgb(107, 107, 107)'),
           tickfont = list(
             size = 14,
             color = 'rgb(107, 107, 107)')),
         #legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'group', bargap = 0.15)


```


```{r}
p2006_2016_Ind_Release

```


The above plot shows the total Release by industry sector in 2006 and 2016.Clearly, a significant increase in release of toxic chemicals can be seen in Metal Mining Industry from 1.21 Billions to 1.55 Billions from 2006 to 2016 i.e an increase of 28%.Also an increase in release can be seen in coal Mining industry from 21 Million to 34 Million, an increase of 68% and in Chemical industry and food industry by  12%. On the other hand, a significant decrease of approximately 30 % can be seen for Electric Utilities, Primary Metals and Plastic & Rubber's Industry.


```{r}

p2006_2016_Ind_Ruse
```


The above plot shows the total Reutilisation of Chemical waste by industry sector in 2006 and 2016
Now, it can be clearly seen that almost all industries have improved their reusing capabilities of chemicals as a rise can be seen in almost all the industries except for metal mining industry where a decrease can be seen. The maximum reutilisation is done by chemical industries as it can be clearly seen from the bar graph whereas the maximum change in reuse of chemical waste can be seen for Food Industry from 245 Million to 1.3 Billion i.e. a change of 400%.Also, petroleum industry has increased the reuse of chemicals from 926 Million to 2.12 billion.


```{r,datafrom 2006 to 2016 wis plotting,include=FALSE}
library(forcats)
yearList <- c()
nonProdList <- c()
electricUtilReleaseList <- c()
yearWise <- c(2006,2007,2008,2009,2010,2011,2012,2013,2014,2015,2016)
filePath<- "C:\\Users\\kv3singh\\Desktop\\Karan\\Toxic Emissions\\2007to2015\\TRI_"
for (year in yearWise){
  fileName <- paste(filePath,year,"_US.csv",sep="")
  fileRead <- paste("TRI",year,sep="")
  fileRead <- read.csv(fileName)
  uniqueRecords <- unique(fileRead)
  rm(fileRead)
  
  uniqueRecords<-uniqueRecords %>% 
    filter( UNIT_OF_MEASURE == "Pounds")
  
  uniqueRecords$TOTAL_RELEASES <- uniqueRecords$TOTAL_RELEASES - uniqueRecords$X6.1_POTW.TRANSFERS_FOR_RELEASE
  uniqueRecords$TOTAL_REUSE <- uniqueRecords$PROD._WASTE_.8.1_THRU_8.7. - uniqueRecords$TOTAL_RELEASES
  
  uniqueRecords$INDUSTRY_SECTOR <- fct_collapse(uniqueRecords$INDUSTRY_SECTOR, Petroleum = c("Petroleum", "Petroleum Bulk Terminals"), Chemicals = c("Chemical Wholesalers", "Chemicals"), Other = c("", "Apparel","Beverages","Computers and Electronic Products","Electrical Equipment","Fabricated Metals","Furniture","Leather","Machinery",
                                    "Miscellaneous Manufacturing" ,"Nonmetallic Mineral Product","Printing","Publishing","Textile Product","Textiles","Tobacco", "Transportation Equipment" , "Wood Products" ))
  
  
  nonProductionRelease <- uniqueRecords$X8.8_ONE.TIME_RELEASE
  nonProductionRelease[is.na(nonProductionRelease)] <- 0
  sumNonProductionRelease <- sum(nonProductionRelease)#,uniqueRecords$UNIT_OF_MEASURE=="Pounds")
  
  uniqueRecords$X8.8_ONE.TIME_RELEASE[is.na(uniqueRecords$X8.8_ONE.TIME_RELEASE)] <- 0
  
  sumElectricUtilRelease <- sum(uniqueRecords$TOTAL_RELEASES, uniqueRecords$INDUSTRY_SECTOR == "Electric Utilities")#,uniqueRecords$UNIT_OF_MEASURE=="Pounds")
  #sumTotalReuse <- sum(uniqueRecords$TOTAL_REUSE, uniqueRecords$INDUSTRY_SECTOR == "Electric Utilities")
  if(year == 2006){
  #dfName <- paste("aggregateTotal",year,sep="")
  aggregateTotal2006 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                        X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2007){
    aggregateTotal2007 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                         X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2008){
    aggregateTotal2008 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                         X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2009){
    aggregateTotal2009 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                         X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2010){
    aggregateTotal2010 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                          X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2011){
    aggregateTotal2011 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                          X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2012){
    aggregateTotal2012 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                          X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2013){
    aggregateTotal2013 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                          X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE,X8.8_ONE.TIME_RELEASE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2014){
    aggregateTotal2014 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                          X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else if(year == 2015){
    aggregateTotal2015 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                          X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  else {
    aggregateTotal2016 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,X5.1_FUGITIVE_AIR,X5.2_STACK_AIR,X5.3_WATER, ON.SITE_RELEASE_TOTAL, OFF.SITE_RELEASE_TOTAL,X8.2_ENERGY_RECOVERY_ON.SITE,X8.3_ENERGY_RECOVERY_OFF.SITE,
                                          X8.4_RECYCLING_ON.SITE,X8.5_RECYCLING_OFF.SITE,X8.6_TREATMENT_ON.SITE,X8.7_TREATMENT_OFF.SITE)~ INDUSTRY_SECTOR , data = uniqueRecords, FUN = sum)
  }
  rm(uniqueRecords)
  yearList <- c(yearList, year)
  nonProdList <- c(nonProdList,sumNonProductionRelease)
  electricUtilReleaseList <- c(electricUtilReleaseList,sumElectricUtilRelease)
  
  }
```



```{r,function to get 10 years dat afor a industry, include=FALSE}
getDataframeIndustryfrom2006_2016 <- function(industryNo){
airElectricList<- c()
waterElectricList<- c()
otherElectricList<- c()
prodWasteElectricList <- c()
totalReuseList <- c()

for (year in yearWise){
  DFName <- paste("aggregateTotal",year,sep="")
  totalRelease <- get(DFName)[industryNo,2]
  airRelease <- get(DFName)[industryNo,5] + get(DFName)[industryNo,6]
  airElectricList<- c(airElectricList,airRelease ) 
  waterRelease <- get(DFName)[industryNo,7]
  waterElectricList<- c(waterElectricList,waterRelease)
  otherRelease <- totalRelease - (airRelease+waterRelease)
  otherElectricList<- c(otherElectricList,otherRelease)
  prodWasteElectricList <- c(prodWasteElectricList,get(DFName)[industryNo,3])
  totalReuseList <- c(totalReuseList,get(DFName)[industryNo,4])
  
}

DF_ElectricUtilities <- data.frame(years = yearWise,airElectricVal= airElectricList, waterElectricVal=waterElectricList, otherElectricVal=otherElectricList,prodWasteVal=prodWasteElectricList,totalReuseVal=totalReuseList)
return(DF_ElectricUtilities)
}
```


**For industry sectors where there is a significant change in the Release or Reuse of chemicals. Lets see the trend of these industries over a period of eleven years from 2006 to 2016.**



```{r,p_MetalMiningRelease, include=FALSE}
p_MetalMiningRelease <- plot_ly(getDataframeIndustryfrom2006_2016(7), x = ~years, y = ~airElectricVal, name = 'Air',alpha = 0.5, type = 'bar',#mode ="lines+markers",
                            marker = list(color = 'rgb(229, 178, 146)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~waterElectricVal, name = 'Water',marker = list(color = 'rgb(0, 255, 255)',line = list(color = 'rgba(0, 255, 255, 1.0)',width = 1))) %>%
  add_trace(y = ~otherElectricVal, name = 'Other',marker = list(color = 'rgb(7, 82, 31)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~prodWasteVal,name = 'Production Waste',type='scatter',mode='lines+markers',line = list(color = 'black')
  )%>%
  layout(title = 'Total Release By Metal Mining US Industries from 2006 to 2016',
         xaxis = list(title = "Year",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Pounds (millions)',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(
                  size = 14,color = 'rgb(107, 107, 107)')),
         legend = list(x = 1, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'stack', bargap = 0.15)

```

```{r}
p_MetalMiningRelease
```


As it can be seen from  the graph, there is no particular trend of release that metal mining industry is following in terms of Chemical Release.But from 2006 to 2016, maximum release can be seen in the year of 2011 and no Reuse can be seen in the year 2013. Whereas overall from 2006 to 2016, there is an increase in the Total Release by Metal Mining industry.And most of the release by this industry is in the Land.



```{r,p_CoalMiningRelease,include=FALSE}
p_CoalMiningRelease <- plot_ly(getDataframeIndustryfrom2006_2016(3), x = ~years, y = ~airElectricVal, name = 'Air',alpha = 0.5, type = 'bar',#mode ="lines+markers",
                            marker = list(color = 'rgb(229, 178, 146)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~waterElectricVal, name = 'Water',marker = list(color = 'rgb(0, 255, 255)',line = list(color = 'rgba(0, 255, 255, 1.0)',width = 1))) %>%
  add_trace(y = ~otherElectricVal, name = 'Other',marker = list(color = 'rgb(7, 82, 31)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~prodWasteVal,name = 'Production Waste',type='scatter',mode='lines+markers',line = list(color = 'black')
  )%>%
  layout(title = 'Total Release By Coal Mining US Industries from 2006 to 2016',
         xaxis = list(title = "Year",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Pounds (millions)',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(
                  size = 14,color = 'rgb(107, 107, 107)')),
         legend = list(x = 1, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'stack', bargap = 0.15)

```

```{r}
p_CoalMiningRelease
```


As it can be seen from  the graph, there is no particular trend of release that Coal mining industry is following in terms of Chemical Release.But from 2006 to 2016, maximum release can be seen in the year of 2008. Whereas overall from 2006 to 2016, there is an increase in the Total Release by Coal Mining industry.And most of the release by this industry is in the Land.A significant increase in air release can be seen from 2007 to 2008 But overall from 2006 to 2016, the releases to air have decreased from 2.7 Million to 1.5 Million.



```{r,p_ElectricalRelease,include=FALSE}
p_ElectricalRelease <- plot_ly(getDataframeIndustryfrom2006_2016(4), x = ~years, y = ~airElectricVal, name = 'Air',alpha = 0.5, type = 'bar',#mode ="lines+markers",
                            marker = list(color = 'rgb(229, 178, 146)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~waterElectricVal, name = 'Water',marker = list(color = 'rgb(0, 255, 255)',line = list(color = 'rgba(0, 255, 255, 1.0)',width = 1))) %>%
  add_trace(y = ~otherElectricVal, name = 'Other',marker = list(color = 'rgb(7, 82, 31)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~prodWasteVal,name = 'Production Waste',type='scatter',mode='lines+markers',line = list(color = 'black')
  )%>%
  layout(title = 'Total Release By Electric Utilities US Industries from 2006 to 2016',
         xaxis = list(title = "Year",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Pounds (millions)',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(
                  size = 14,color = 'rgb(107, 107, 107)')),
         legend = list(x = 1, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'stack', bargap = 0.15)

```

```{r}
p_ElectricalRelease
```


As it can be seen from  the graph, the trend is more or less on decreasing of the chemical release by Electric Utilities industry.But from 2006 to 2016, maximum release can be seen in the year of 2007. Whereas overall from 2006 to 2016, there is an decrease in the Total Release by Electric Utilities industry.And most of the release by this industry is in the Land now.One of the interesting things that can be seen in the graph is decreasing releases to Air which can be seen decreasing every year from 2007 to 2016. While overall the land releases have increased from 2006 to 2016 and air releases have decreased.The production waste has remain more or less constant over the years.



```{r,p_PrimaryMetalsRelease,include=FALSE}
p_PrimaryMetalsRelease <- plot_ly(getDataframeIndustryfrom2006_2016(11), x = ~years, y = ~airElectricVal, name = 'Air',alpha = 0.5, type = 'bar',#mode ="lines+markers",
                                   marker = list(color = 'rgb(229, 178, 146)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~waterElectricVal, name = 'Water',marker = list(color = 'rgb(0, 255, 255)',line = list(color = 'rgba(0, 255, 255, 1.0)',width = 1))) %>%
  add_trace(y = ~otherElectricVal, name = 'Other',marker = list(color = 'rgb(7, 82, 31)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
 # add_trace(y = ~totalReuseVal, name = 'Reuse',marker = list(color = 'rgb(55, 55, 31)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~prodWasteVal,name = 'Production Waste',type='scatter',mode='lines+markers',line = list(color = 'black'))%>%
  layout(title = 'Total Release By Primary Metals US Industries from 2006 to 2016',
         xaxis = list(title = "Year",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Pounds (millions)',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(
           size = 14,color = 'rgb(107, 107, 107)')),
         legend = list(x = 1, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'stack', bargap = 0.15)


```

```{r}
p_PrimaryMetalsRelease
```


As it can be seen from  the graph, the trend is more or less on decreasing of the chemical release by Primary Metals industry.From 2006 to 2016, maximum release can be seen in the year of 2006. Whereas overall from 2006 to 2016, there is an decrease in the Total Land Release by Primary Metals industry.Most of the release by this industry is still in the Land.Overall, the releases to Air, Water and Land have decreased over the decade.




```{r,function to get 10 years data of reuse for a industry, include=FALSE}

getBarPlotIndustryTitleReuse2006_2016 <- function( usIndustry ){
  title_Reuse_Ind <- paste('Total Reuse By' ,usIndustry , 'US Industries from 2006 to 2016')
  return(title_Reuse_Ind)
}
getPlotReuseIndustryfrom2006_2016 <- function(industryNo, industryType){
  totalRecycleList<- c()
  totalRecoveryList<- c()
  totalTreatmentList<- c()
  prodWasteElectricList <- c()
  totalReuseList <- c()
  
  for (year in yearWise){
    DFName <- paste("aggregateTotal",year,sep="")
    totalRecycle <- get(DFName)[industryNo,12]+ get(DFName)[industryNo,13]
    #airRelease <- get(DFName)[industryNo,5] + get(DFName)[industryNo,6]
    totalRecycleList<- c(totalRecycleList,totalRecycle ) 
    totalRecovery <- get(DFName)[industryNo,10]+ get(DFName)[industryNo,11]
    totalRecoveryList<- c(totalRecoveryList,totalRecovery)
    totalTreatment <- get(DFName)[industryNo,14] + get(DFName)[industryNo,15]
    totalTreatmentList<- c(totalTreatmentList,totalTreatment)
    prodWasteElectricList <- c(prodWasteElectricList,get(DFName)[industryNo,3])
    totalReuseList <- c(totalReuseList,get(DFName)[industryNo,4])
    
  }
  
  DF_ReuseUtilities <- data.frame(years = yearWise,totalRecycleVal= totalRecycleList, totalRecoveryVal=totalRecoveryList, totalTreatmentVal=totalTreatmentList,prodWasteVal=prodWasteElectricList,totalReuseVal=totalReuseList)
  p_ElectricalRuse <- plot_ly(DF_ReuseUtilities, x = ~years, y = ~totalRecycleVal, name = 'Recycling',alpha = 0.5, type = 'bar',#mode ="lines+markers",
                              marker = list(color = 'rgb(64, 224, 118)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
    add_trace(y = ~totalRecoveryVal, name = 'Recovery',marker = list(color = 'rgb(248, 81, 27)',line = list(color = 'rgba(248, 81, 27, 1.0)',width = 1))) %>%
    add_trace(y = ~totalTreatmentVal, name = 'Treatment',marker = list(color = 'rgb(64, 25, 118)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
    add_trace(y = ~prodWasteVal,name = 'Production Waste',type='scatter',mode='lines+markers',line = list(color = 'black')
    )%>%
    layout(title = getBarPlotIndustryTitleReuse2006_2016(industryType),
           xaxis = list(title = "Year",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
           yaxis = list(title = 'Pounds',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(
             size = 14,color = 'rgb(107, 107, 107)')),
           legend = list(x = 1, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
           barmode = 'stack', bargap = 0.15)
  return(p_ElectricalRuse)
}

```


```{r}
p_MetalMiningRuse <- getPlotReuseIndustryfrom2006_2016(7, "Metal Mining")
p_MetalMiningRuse
```



As can be seen from the graph, that the reuse of the total production waste generated by Metal Mining industry has been very less throughout all the years.From 2006 to 2016, there has been a slight decrease in the reuse of chemicals. But the good thing is that the amount that they reuse is basically in the form of recycling and that is the most preferred way after source reduction of chemicals. So it's good that the industry has shifted from Land treatment towards recylcing of the chemicals over the years but still compared to the amount of waste that the metal mining industry sector is generating, the quantity of reuse is less.



```{r}
p_ChemicalRuse <- getPlotReuseIndustryfrom2006_2016(2, "Chemicals")
p_ChemicalRuse
```



As can be seen from the graph, that the reuse of the total production waste generated by chemical industry has remained high throughout all the years.From 2006 to 2016, a major jump in reuse of chemicals can be seen from 2013 to 2014.Overall, the reuse of production waste by chemicals industry has increased year by year from 2006 to 2016. The interesting thing is that they have significantly increase the quantity of chemical that they recyle the waste generated and that is the most preferred way after source reduction.



```{r}
p_FoodRuse <- getPlotReuseIndustryfrom2006_2016(5, "Food")
p_FoodRuse
```



Now, for food industry, with the increase of production waste, the quantity of reuse has also increased over all the years.The major portion of the production waste is recycled by the food industry.



Now seeing the Trend of onsite and offsite release by industries over the period of 10 years.


```{r, onsite off site release, also contains air water release, over all years,include=FALSE}
sumAirReleaseList <- c()
sumWaterReleaseList <- c()
sumLandReleaseList <- c()
totalOnsiteReleaseList <- c()
totalOffsiteReleaseList <- c()
totalReleaseByYearList <-c()
for (year1 in yearWise){
  DFName <- paste("aggregateTotal",year1,sep="")
  airReleaseByYear <- sum(get(DFName)[,5]) + sum(get(DFName)[,6])# 5 = fugitive, 6= stack
  sumAirReleaseList <- c(sumAirReleaseList, airReleaseByYear)
  waterReleaseByYear <- sum(get(DFName)[,7])# 7 water
  sumWaterReleaseList <- c(sumWaterReleaseList, waterReleaseByYear)
  totalReleaseByYear <- sum(get(DFName)[,2]) #Total release
  totalReleaseByYearList <-c(totalReleaseByYearList,totalReleaseByYear)
  landReleaseByYear <- totalReleaseByYear -(airReleaseByYear+waterReleaseByYear)
  sumLandReleaseList <- c(sumLandReleaseList,landReleaseByYear)
  totalOnsiteRelease <- sum(get(DFName)[,8])
  totalOnsiteReleaseList <- c(totalOnsiteReleaseList,totalOnsiteRelease)
  totalOffsiteRelease <- sum(get(DFName)[,9])
  totalOffsiteReleaseList <- c(totalOffsiteReleaseList,totalOffsiteRelease)
}

onOFFReleaseDF <- data.frame(years = yearWise,totalOnsiteRel= totalOnsiteReleaseList, totalOffsiteRel=totalOffsiteReleaseList, totalRel=totalReleaseByYearList)

p_onOFFRelease<- plot_ly(onOFFReleaseDF, x = ~years, y = ~totalOnsiteRel, name = 'totalOnsiteRel',alpha = 0.5, type = 'scatter',mode ="lines+markers",
                         marker = list(color = 'rgb(229, 178, 146)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  add_trace(y = ~totalOffsiteRel, name = 'totalOffsiteRel',marker = list(color = 'rgb(0, 255, 255)',line = list(color = 'rgba(0, 255, 255, 1.0)',width = 1))) %>%
  add_trace(y = ~totalRel, name = 'totalRel',marker = list(color = 'rgb(7, 82, 31)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  #add_trace(y = ~totalReuseVal, name = 'Reuse',marker = list(color = 'rgb(55, 55, 31)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  #add_trace(y = ~prodWasteVal,name = 'Production Waste',type='scatter',mode='lines+markers',line = list(color = 'black'))%>%
  layout(title = 'Total Onsite and Offsite Release By US Industrial Facilities from 2006 to 2016',
         xaxis = list(title = "Year",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Pounds',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(
           size = 14,color = 'rgb(107, 107, 107)')),
         legend = list(x = 1, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'stack', bargap = 0.15)


```


```{r}
p_onOFFRelease
```


The offsite release is very less as compared to the onsite release and that is a good thing.Overall, over the years there can be seen a decrease in the offsite release by industrial facilities whereas not much change can be seen in the onsite release from 2006 to 2016.

###One Time Release Analysis
**One Time Release :** This is the quantity released to the environment by industrial facilities as a result of remedial actions, catastrophic events, or one-time events not associated with production processing.


```{r, one time release , include=FALSE}
DF_OneTimeRel <- data.frame(years = yearList,nonProdVal= nonProdList, electricUtilReleaseVal=electricUtilReleaseList)
p_oneTimeRelease <- plot_ly(DF_OneTimeRel, x = ~years, y = ~nonProdVal, name = '2006', type = 'scatter',mode ="lines+markers",
              marker = list(color = 'rgb(229, 178, 146)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  layout(title = 'Non production Release By US Industries from 2006 to 2016',
         xaxis = list(title = "Year",tickfont = list(size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Pounds (millions)',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(size = 14,color = 'rgb(107, 107, 107)')),
         legend = list(x = 0, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'group', bargap = 0.15)


```


```{r}
p_oneTimeRelease
```


The graph depicts the overall one time release by all the industrial facilities in a given year starting from 2006 to 2016.A major peak can be seen in the year of 2013 where one time release has gone up to 100 million pounds whereas on average for each year it's around 20 Million.So, further analysing what was the cause of a sudden peak in 2013.


```{r}
p_2013NonProdIndustryWise <- plot_ly(aggregateTotal2013, x = ~INDUSTRY_SECTOR, y = ~X8.8_ONE.TIME_RELEASE, name = 'One Time Release',alpha = 0.5, type = 'bar',
                                 marker = list(color = 'rgb(229, 178, 146)',line = list(color = 'rgba(246, 78, 139, 1.0)',width = 1))) %>%
  layout(title = 'One Time Release By Industrial Facilities in 2013',
         xaxis = list(title = "Industry",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Pounds (millions)',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),tickfont = list(
           size = 14,color = 'rgb(107, 107, 107)')),
         legend = list(x = 1, y = 1, bgcolor = 'rgba(255, 255, 255, 0)', bordercolor = 'rgba(255, 255, 255, 0)'),
         barmode = 'stack', bargap = 0.15)
p_2013NonProdIndustryWise
```


On going through the one time release by US industrial Facilities in 2013, the reason came clear for such a high peak in 2013 and it was due to metal mining industrial activity in 2013 that caused an unexpected high one time release.


```{r,Finding which facility did it, include=FALSE }
####Finding which facility did it
TRI2013 <- read.csv("C:\\Users\\kv3singh\\Desktop\\Karan\\Toxic Emissions\\2007to2015\\TRI_2013_US.csv")

uniqueTRI2013 <- unique(TRI2013)
uniqueTRI2013$X8.8_ONE.TIME_RELEASE[is.na(uniqueTRI2013$X8.8_ONE.TIME_RELEASE)] <- 0
unique1TRI2013 <- uniqueTRI2013%>%
  dplyr::filter( UNIT_OF_MEASURE == "Pounds" & INDUSTRY_SECTOR == "Metal Mining")%>%
  dplyr::group_by(FACILITY_NAME,LONGITUDE,LATITUDE,ST) %>% 
  dplyr::summarise(TOTAL_ONETIMERELEASE = sum(X8.8_ONE.TIME_RELEASE))%>%
  ungroup%>%
  dplyr::mutate(perCent=round(TOTAL_ONETIMERELEASE/sum(TOTAL_ONETIMERELEASE)*100, 2))%>%
  dplyr::arrange(desc(TOTAL_ONETIMERELEASE))%>%
  dplyr::top_n(5,TOTAL_ONETIMERELEASE)

```

```{r,Finding which facility did it1, include=FALSE }
pMetalIndustry_2013 <- plot_geo(unique1TRI2013,lat = ~LATITUDE, lon = ~LONGITUDE) %>%
  add_markers(color = ~FACILITY_NAME,symbol = I(21), sizes = c(10, 40),colors = "Dark2",opacity =0.8, size = ~perCent,
              marker=list(sizeref=5),text = ~paste("Industry : Metal Mining",  "<br>","FACILITY_NAME :", FACILITY_NAME, "<br>",
                            "Percent :",perCent,  "<br>","STATE :", ST, "<br>", #"FEDERAL_FACILITY : ", FEDERAL_FACILITY, "<br>",   "METAL :", METAL, "<br>",
                            "TOTAL_RELEASES :", TOTAL_ONETIMERELEASE),hoverinfo = "text")%>% # "<br>", "TOTAL PRODUCTION WASTE :", PROD._WASTE_.8.1_THRU_8.7., "<br>",                                                              
  #"TOTAL REUSE :",TOTAL_REUSE ), hoverinfo = "text") %>%
  #colorbar(title = "Industry Type") %>%
  # need to add total release value in title i.e totalRelease2006$TOTAL_RELEASES[2]
  layout(
    showlegend = FALSE,
    title = 'Metal Mining Industrial Facilities that were Responsible for Extreme One Time Release (2013) <br>(Hover for breakdown)',
    geo = g
  )

```



```{r}
pMetalIndustry_2013
```


So, it was due to Kennecott Barneys Canyon Mining Co. On 10 April 2013, Rio Tinto Kennecott in Salt Lake City, Utah, the largest landslide was experienced in the history of mining, with 135 million tonnes of material covering the lower pit of the Bingham Canyon Mine.Because of Kennecott's strong safety culture, preparation and sophisticated monitoring systems, no one was hurt during the slide.



##Analysis of Chemicals
```{r, include=FALSE}
chemicalList <- read.csv("C:\\Users\\kv3singh\\Desktop\\Karan\\Toxic Emissions\\2007to2015\\ChemicalsByHealth.csv",stringsAsFactors = FALSE)

chemical2016 <- aggregate(cbind(TOTAL_RELEASES,PROD._WASTE_.8.1_THRU_8.7.,TOTAL_REUSE,TOTAL_RECYLE,TOTAL_RECOVERY,TOTAl_TREATMENT) ~ CHEMICAL+CAS_..COMPOUND_ID+CLEAR_AIR_ACT_CHEMICAL+METAL+CLASSIFICATION, data = filterPound2016, FUN = sum)


chemical2016 <-  chemical2016%>%
                 mutate(perCent=round(TOTAL_RELEASES/sum(TOTAL_RELEASES)*100, 2)) %>% 
                 mutate(ratioRel2Pro=round((TOTAL_REUSE/PROD._WASTE_.8.1_THRU_8.7.)*100, 2))

chemicalList <- dplyr::rename(chemicalList, CAS_..COMPOUND_ID = Chemical.ID..9.digits. )
chemicalList[is.na(chemicalList)] <- 0
chemicalList <- dplyr::mutate(chemicalList, TOTAL_HEALTHISSUES = OSHA.Carcinogens + Other.Health.Effects+BODY_WEIGHT+CARDIOVASCULAR+DERMAL+DEVELOPMENTAL+ENDOCRINE                  +GASTROINTESTINAL+HEMATOLOGICAL+HEPATIC+IMMUNOLOGICAL+METABOLIC+MUSCULOSKELETAL+NEUROLOGICAL+OCULAR+OTHER_SYSTEMIC+RENAL+REPRODUCTIVE+RESPIRATORY+Human.health.effects.information.not.identified +ACUTE+INTERMEDIATE+CHRONIC)%>%                                     
dplyr::select(TOTAL_HEALTHISSUES,CAS_..COMPOUND_ID)                                                
mergedChemical <- merge(chemical2016, chemicalList, by="CAS_..COMPOUND_ID")

mergedChemical <- arrange(mergedChemical, desc(TOTAL_RELEASES),desc(TOTAL_HEALTHISSUES))

tenChemical2016 <- mergedChemical %>%
                  top_n(10,TOTAL_RELEASES)

tenHealthChemical2016 <- mergedChemical %>%
                    top_n(10,TOTAL_HEALTHISSUES)
mergedChemicalRelease <- mergedChemical %>%
                        top_n(10,TOTAL_HEALTHISSUES)
#################to find arsenic release(most hazardous) caused by which industry
arsenicRelease <- filterPound2016%>%
                  dplyr::group_by(INDUSTRY_SECTOR) %>% 
                  dplyr::filter(CAS_..COMPOUND_ID == 'N020')%>% #aresnic compound
                  dplyr::summarise(total_arsenicRelease = sum(TOTAL_RELEASES))%>%
                  dplyr::mutate(perCent=round(total_arsenicRelease/sum(total_arsenicRelease)*100, 2))%>%
                  dplyr::select(INDUSTRY_SECTOR,perCent,total_arsenicRelease)
```



**Finding the top ten most released Chemicals by the US Industrial Facilities** 
```{r}
p2016_chemical <- ggplot(data = tenChemical2016, aes(CHEMICAL, TOTAL_RELEASES/1000000,  name = "Millions"))
p2016_chemical <- p2016_chemical +geom_col(aes(fill = factor(TOTAL_HEALTHISSUES)), alpha = 0.5, col="red")+labs(y = "Millions of pound")
p2016_chemical <- p2016_chemical +coord_flip()+ ggtitle("Top Ten Chemicals Released by US Industrial Facilities")   + guides(fill=guide_legend(title="Health Factors"))
p2016_chemical <- p2016_chemical + scale_y_continuous(limits = c(0,900))+geom_text(aes(label = paste(perCent,"%"), hjust = -0.1))
p2016_chemical
```


The above 10 chemicals contribute to about 77% of the total Chemical Releases in the year 2016. The bars are coloured according to the number of health issues that each of these chemicals cause. While Arsenic compounds are the most dangerous based on the number of health problems they cause to humans and animals.In the second number are the lead compounds that are reponsible for 8 types of health issues in human and they correspond to 20% of the total Release in U.S. in 2016.

**Finding the Top Ten Hazardous to Health Chemicals that are released by US industries.**


```{r}
p2016_Healthchemical <- ggplot(data = tenHealthChemical2016, aes(CHEMICAL, perCent,  name = "Millions"))
p2016_Healthchemical <- p2016_Healthchemical +geom_col(aes(fill = factor(TOTAL_HEALTHISSUES)))+labs(y = "Percent")
p2016_Healthchemical <- p2016_Healthchemical +coord_flip()+ ggtitle("Top Ten Hazardous to Health Chemicals Released by US Industrial Facilities")   + guides(fill=guide_legend(title="Health Factors"))
p2016_Healthchemical
```


As can be seen , Arsenic Compuounds are the most hazardous chemicals that were released to the environment(around 4.7%) in 2016. Rest of the hazardous chemicals have a quite small proportion in the total release.
Now lets see which industry is causing the release of these arsenic compounds.


```{r,arfsenic, include=FALSE}
p2016_ArsenicWaste <- plot_ly(arsenicRelease, labels = ~INDUSTRY_SECTOR, values = ~total_arsenicRelease, type = 'pie',
                                textposition = 'inside',
                                textinfo = 'label+percent',
                                insidetextfont = list(color = '#FFFFFF'),
                                hoverinfo = 'text',
                                text = ~paste(round((total_arsenicRelease)/1000000,2), ' millions lb'),
                                marker = list(line = list(color = '#FFFFFF', width = 1)),
                                showlegend = TRUE,alpha = 0.5) %>%
  layout(title = 'Arsenic Compounds Release by Industry Sector in 2016', showlegend = TRUE,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```

```{r}
p2016_ArsenicWaste
```


As can be seen from the pie chart above, the major releasing of Arsenic compounds is done by Metal Mining Industry. So, Alaska in which the maximum release is done by Metal Mining industry is getting the max release of these Compounds,


```{r, lead Release , include=FALSE}
leadCompundsRelease <- filterPound2016%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>% 
  dplyr::filter(CAS_..COMPOUND_ID == 'N420')%>% #aresnic compound
  dplyr::summarise(total_leadRelease = sum(TOTAL_RELEASES))%>%
  dplyr::mutate(perCent=round(total_leadRelease/sum(total_leadRelease)*100, 2))%>%
  dplyr::select(INDUSTRY_SECTOR,perCent,total_leadRelease)

p2016_LeadCWaste <- plot_ly(leadCompundsRelease, labels = ~INDUSTRY_SECTOR, values = ~total_leadRelease, type = 'pie',
                              textposition = 'inside',
                              textinfo = 'label+percent',
                              insidetextfont = list(color = '#FFFFFF'),
                              hoverinfo = 'text',
                              text = ~paste(round((total_leadRelease)/1000000,2), ' millions lb'),
                              marker = list(line = list(color = '#FFFFFF', width = 1)),
                              showlegend = TRUE,alpha = 0.5) %>%
  layout(title = 'Lead Compounds Release Waste by Industry Sector in 2016', showlegend = TRUE,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```


**Now seeing the Distribution of release  of Lead compounds by Industry sectors.**


```{r}
p2016_LeadCWaste
```


Again, the major releasing industry for Lead compounds is Metal Mining followed by Electric Utilities.

```{r, chemical scatter plot, include=FALSE}
p2016_ChemicalScatter <- plot_ly(data = chemical2016, x = ~TOTAL_REUSE, y = ~PROD._WASTE_.8.1_THRU_8.7., mode = "markers",type = "scatter",color = ~CLASSIFICATION,
                                 text = ~paste("CHEMICAL :",CHEMICAL,"<br>","Reuse Percent :",ratioRel2Pro,"<br>","CLEAR_AIR_ACT_CHEMICAL :",CLEAR_AIR_ACT_CHEMICAL,"<br>","Metal :",METAL,"<br>","CLASSIFICATION :",CLASSIFICATION) 
                                 ,marker = list(size = ~15,opacity = 0.5,
                                 line = list(color = 'rgba(152, 0, 0, .8)',width = 2))) %>%
  layout(title = 'Chemical Produce Vs Reuse(2016)',
         xaxis = list(title = "Total Reuse",tickfont = list( size = 14,color = 'rgb(107, 107, 107)')),
         yaxis = list(title = 'Total Production Waste',titlefont = list(size = 16,color = 'rgb(107, 102, 107)'),
                      tickfont = list(size = 14,color = 'rgb(107, 107, 107)'))
  )
```
```{r}
p2016_ChemicalScatter
```


As it can be seen from the graph, that most of the chemicals that are produced by the industrial
facilities are reused by them with some of the exceptions that can be seen from the scatter plot.
Cumene is the most produced and reused chemical in the United States followed by Methanol and then Toulene.

The two weird points can be seen and these are of Lead compounds(a PBT i.e  Persistent Bioaccumulatvie Toxic - harmful chemicals that persist overtime (do not break down easily in the environment) and are especially hazardous for human health and ecosystems) and zinc compounds which have aroung 40% reuse.As we have seen above, Metal Mining Industrial Facilities contribute majorly for the release of the lead compounds.**Mercury compounds** which is also a PBT has a reuse percent of only 3%.We will further analyse which industry produces mercury compounds.

Also Arsenic Compounds have only 0.81 % reuse and Barium Compounds (4.4%) i.e out of 168.8 Milion pounds only 1.36 Million pound is reused.We will further see which distribution of industry sectors that produces the Barium Compounds.

**Industry wise Distribution of Cumene's Production Waste(2016)**

```{r, Cumene, include=FALSE}
CumeneRelease <- filterPound2016%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>% 
  dplyr::filter(CHEMICAL == 'CUMENE')%>% #aresnic compound
  dplyr::summarise(total_CumeneWaste = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCent=round(total_CumeneWaste/sum(total_CumeneWaste)*100, 2))%>%
  dplyr::select(INDUSTRY_SECTOR,perCent,total_CumeneWaste)
  

p2016_CumeneWaste <- plot_ly(CumeneRelease, labels = ~INDUSTRY_SECTOR, values = ~total_CumeneWaste, type = 'pie',
                              textposition = 'inside',
                              textinfo = 'label+percent',
                              insidetextfont = list(color = '#FFFFFF'),
                              hoverinfo = 'text',
                              text = ~paste(round((total_CumeneWaste)/1000000,2), ' millions lb'),
                              marker = list(line = list(color = '#FFFFFF', width = 1)),
                              showlegend = TRUE,alpha = 0.5) %>%
  layout(title = 'Cumene Production Waste by Industry Sector in 2016', showlegend = TRUE,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```

```{r}
p2016_CumeneWaste
```

As we saw above that Chemical industry reuses most of the chemical waste it generates, and the main chemical that is being reused(recycled or recovered or treated) in chemical industry is **CUMENE**. Chemical Industry accounts for 99.8% of the total production waste of Cumene in US.
**Industry wise Distribution of Methanol's Production Waste(2016)**
```{r,methanol, include=FALSE}
methanolRelease <- filterPound2016%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>% 
  dplyr::filter(CHEMICAL == 'METHANOL')%>% #aresnic compound
  dplyr::summarise(total_MethanolWaste = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCent=round(total_MethanolWaste/sum(total_MethanolWaste)*100, 2))%>%
  dplyr::select(INDUSTRY_SECTOR,perCent,total_MethanolWaste)


p2016_MethanolWaste <- plot_ly(methanolRelease, labels = ~INDUSTRY_SECTOR, values = ~total_MethanolWaste, type = 'pie',
                             textposition = 'inside',
                             textinfo = 'label+percent',
                             insidetextfont = list(color = '#FFFFFF'),
                             hoverinfo = 'text',
                             text = ~paste(round((total_MethanolWaste)/1000000,2), ' millions lb'),
                             marker = list(line = list(color = '#FFFFFF', width = 1)),
                             showlegend = TRUE,alpha = 0.5) %>%
  layout(title = 'Methanol Production Waste by Industry Sector in 2016', showlegend = TRUE,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```

```{r}
p2016_MethanolWaste
```

Methanol is mainly produced by Paper and Chemicals industry i.e. around 90%.

**Industry wise Distribution of Barium Compounds Production Waste(2016)**

```{r, barium, include=FALSE}
BariumRelease <- filterPound2016%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>% 
  dplyr::filter(CHEMICAL == 'BARIUM COMPOUNDS')%>% #aresnic compound
  dplyr::summarise(total_BariumWaste = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCent=round(total_BariumWaste/sum(total_BariumWaste)*100, 2))%>%
  dplyr::select(INDUSTRY_SECTOR,perCent,total_BariumWaste)

p2016_BariumWaste <- plot_ly(BariumRelease, labels = ~INDUSTRY_SECTOR, values = ~total_BariumWaste, type = 'pie',
                              textposition = 'inside',
                              textinfo = 'label+percent',
                              insidetextfont = list(color = '#FFFFFF'),
                              hoverinfo = 'text',
                              text = ~paste(round((total_BariumWaste)/1000000,2), ' millions lb'),
                              marker = list(line = list(color = '#FFFFFF', width = 1)),
                              showlegend = TRUE,alpha = 0.5) %>%
  layout(title = 'Barium Compounds Production Waste by Industry Sector in 2016', showlegend = TRUE,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))


```

```{r}
p2016_BariumWaste
```


The major producer of Barium Compounds is Electric Utilities industry follwed by Metal Mining.
Only 4% of the total chemical produced as waste gets reused.


```{r, mercury PBT, include=FALSE}
MercuryRelease <- filterPound2016%>%
  dplyr::group_by(INDUSTRY_SECTOR) %>% 
  dplyr::filter(CHEMICAL == 'MERCURY COMPOUNDS')%>% #aresnic compound
  dplyr::summarise(total_MercuryWaste = sum(PROD._WASTE_.8.1_THRU_8.7.))%>%
  dplyr::mutate(perCent=round(total_MercuryWaste/sum(total_MercuryWaste)*100, 2))%>%
  dplyr::select(INDUSTRY_SECTOR,perCent,total_MercuryWaste)


p2016_MercuryWaste <- plot_ly(MercuryRelease, labels = ~INDUSTRY_SECTOR, values = ~total_MercuryWaste, type = 'pie',
                             textposition = 'inside',
                             textinfo = 'label+percent',
                             insidetextfont = list(color = '#FFFFFF'),
                             hoverinfo = 'text',
                             text = ~paste(round((total_MercuryWaste)/1000000,2), ' millions lb'),
                             marker = list(line = list(color = '#FFFFFF', width = 1)),
                             showlegend = TRUE,alpha = 0.5) %>%
  layout(title = 'Mercury Compounds Production Waste by Industry Sector in 2016', showlegend = TRUE,
         xaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE),
         yaxis = list(showgrid = FALSE, zeroline = FALSE, showticklabels = FALSE))

```

```{r}
p2016_MercuryWaste
```

Mercury Compounds(a PBT) is mainly released by Metal Mining Industry.
```{r, zero reuse chemicals, include=FALSE}
zeroReuseChemicals2016 <- chemical2016%>%
                            dplyr::filter(ratioRel2Pro == 0.00)%>%
                            dplyr::select(CHEMICAL)
```

**Below are the chemicals which have zero reuse i.e. the production waste of these chemicals is as it is released into the environment.**
```{r}
zeroReuseChemicals2016
```


###Tribal land Facilities
**Industrial facilities that are located on the tribal land.**


```{r, tribal facilities, include=FALSE}
filterPound2016$TRIBE[filterPound2016$TRIBE==""]<-NA
TribeRelease2016 <- filterPound2016%>%
  dplyr::filter(!is.na(TRIBE))%>%
  dplyr::group_by(TRIBE,FACILITY_NAME,ST,CITY,INDUSTRY_SECTOR,LONGITUDE,LATITUDE) %>% 
  dplyr::summarise(TOTAL_TRIBERELEASES = sum(TOTAL_RELEASES))%>%
  ungroup%>%
  dplyr::mutate(perCent=round(TOTAL_TRIBERELEASES/sum(TOTAL_TRIBERELEASES)*100, 2))%>%
  dplyr::arrange( desc(TOTAL_TRIBERELEASES))
```  

```{r, tribal facilities1, include=FALSE}
pTribeFacilities <- plot_geo(TribeRelease2016,lat = ~LATITUDE, lon = ~LONGITUDE) %>%
  add_markers(color = ~INDUSTRY_SECTOR,sizes = c(5, 30),marker=list(sizeref=0.1, sizemode="area"), colors = "Dark2",symbol = I(19),opacity =0.5, size = ~TOTAL_TRIBERELEASES,
              text = ~paste("Industry :", INDUSTRY_SECTOR, "<br>","FACILITY_NAME :", FACILITY_NAME, "<br>",
                                                   "Percent :",perCent,  "<br>","STATE :", ST, "<br>", "CITY : ", CITY, "<br>",  # "METAL :", METAL, "<br>",
                                                   "TOTAL_RELEASES :", round(TOTAL_TRIBERELEASES/1000000,3),"M pounds"),hoverinfo = "text")%>% # "<br>", "TOTAL PRODUCTION WASTE :", PROD._WASTE_.8.1_THRU_8.7., "<br>",                                                              
  #"TOTAL REUSE :",TOTAL_REUSE ), hoverinfo = "text") %>%
  #colorbar(title = "Industry Type") %>%
  # need to add total release value in title i.e totalRelease2006$TOTAL_RELEASES[2]
  layout(
    showlegend = TRUE,
    title = 'Industrial Facilities on Tribal Land and their Release (2016) <br>(Hover for breakdown)',
    geo = g
  )

```


```{r}
pTribeFacilities
```


Only 40 industrial facilities taht are located in the Tribal Land reported to the TRI in 2016. Out of these, the top 4 constitute about 90% of the releases in the tribal land.

1)**Tohono O'odham Nation of Arizona (Tribe)**, ASARCO LLC MISSION COMPLEX(Facility Name), in Arizona, Metal Mining Industry(48.72% Release)

2)**Ute Indian Tribe of the Uintah & Ouray Reservation**, BONANZA POWER PLANT(Facility Name), in Utah, Electric Utilities Industry(22.94% Release)

3)**Navajo Nation, Arizona, New Mexico & Utah**, FOUR CORNERS STEAM ELECTRIC STATION(Facility Name), in New Mexico, Electric Utilities Industry(12.73% Release)

4)**Navajo Nation, Arizona, New Mexico & Utah**, SALT RIVER PROJECT NAVAJO GENERATING STATION(Facility Name), in Arizona, Electric Utilities Industry(10.01% Release)



#**Significance testing**

##**Hypothesis 1**

###Null Hypothesis ($H_0$): Number of industrial facilities in a state is independent of the Population of that state

```{r}
USPopulation1 <- read.csv("C:\\Users\\kv3singh\\Desktop\\Karan\\Toxic Emissions\\2007to2015\\USPopulation1.csv")

industryCountState2016 <-as.data.frame(table(mergeFacilityData2k16$ST))
industryCountState2016$ST <- industryCountState2016$Var1
mergeUSPopInd <- merge(industryCountState2016,USPopulation1, by = "ST") 

mixCoordinates <- function(USInd){
  n <- length(USInd$Population)
  stopifnot(n == length(USInd$Freq))
  population_samples <- sample(USInd$Population, n , replace = FALSE)
  data.frame(x = population_samples, y= USInd$Freq)
}
#fitting on sample data
stdDev_Samples <-c()
for (i in 1:1000){
  mixCoord <- mixCoordinates(mergeUSPopInd)
  smoothFit <- loess(mixCoord$y ~ mixCoord$x, family = "symmetric")
  stdDev_Samples <-c(stdDev_Samples, sd(smoothFit$fitted))
}

limit_x <-c(0,500)
hist(stdDev_Samples,breaks = 30,col = "steelblue",xlim = limit_x,main = "", xlab = "s")
#fitting in actual data
smoothFitRobust <- loess(mergeUSPopInd$Freq ~ mergeUSPopInd$Population , data = mergeUSPopInd, family = "symmetric")

s <- sd(smoothFitRobust$fitted)
abline(v=s, col="red",lty=2)
```



The value of standard deviation for the data is 440.96.On doing it 1000 times, the observed value of s= 440.96 looks unusual.The probability of observing something at least as strange as the observed data is 0.This corresponds to an observed significance level of 0 and provides very strong evidence against the null hypothesis.Therefore we have very strong evidence that number of industrial facilities in a state is independent of the Population of that state.

##**Hypothesis 2**
###Null Hypothesis ($H_0$) : Total Release of a state is independent of the Number of industrial facilities in that state(2016)


```{r}


indReleaseTest <- merge(dfRelease2016, mergeUSPopInd, by = "ST")
mixCoordinates2 <- function(USInd){
  n <- length(USInd$TOTAL_RELEASES)
  stopifnot(n == length(USInd$Freq))
  release_samples <- sample(USInd$TOTAL_RELEASES, n , replace = FALSE)
  data.frame(x = release_samples, y= USInd$Freq)
}

stdDev_Samples1 <-c()
for (i in 1:1000){
  mixCoord <- mixCoordinates2(indReleaseTest)
  smoothFit <- loess(mixCoord$y ~ mixCoord$x, family = "symmetric")
  stdDev_Samples1 <-c(stdDev_Samples1, sd(smoothFit$fitted))
  #r <- cor(mixCoord$y,mixCoord$x)
  #stdDev_Samples1 <-c(stdDev_Samples1, r)
}
limit_x <-c(0,500) #c(-1,1)#
hist(stdDev_Samples1,breaks = 30,col = "steelblue",xlim = limit_x,main = "", xlab = "Standard Deviation")
#r <- cor(indReleaseTest$Population,indReleaseTest$Freq)
#fitting in actual data
smoothFitRobust2 <- loess(indReleaseTest$Freq ~ indReleaseTest$TOTAL_RELEASES , data = indReleaseTest, family =
                           "symmetric")

s2 <- sd(smoothFitRobust2$fitted)
abline(v=s2, col="red",lty=2)


```


The value of standard deviation for the data is 254.18.On doing it 1000 times, the observed value of s= 254.18 looks unusual.The probability of observing something at least as strange as the observed data is 0.003%.This corresponds to an observed significance level of 0.003 and provides  strong evidence against the null hypothesis.Therefore we have a strong evidence that total release of chemicals in a state is independent of the number of industrial facilities in that state.

##**Hypothesis 3**
###Null Hypothesis($H_0$) : Total Reuse of Produced Chemical Waste by a state's industrial facilities is independent of the Total Produced Chemical Waste by industrial facilities of that state(2016)


```{r}
#Line up test for more the production waste , more the reuse


#transform2uniform function
transform2uniform <- function(x, a = if(length(x) <= 10) 3/8 else 1/2, ...)
{(rank(x, ...) - a) / length(x)}

#function to get mix waiting times to check for their independence
mixCoordinates3 <- function(releaseData){
  n <- length(releaseData$x)
  stopifnot(n == length(releaseData$y))
  prodWaste_samples <- sample(releaseData$x, n , replace = FALSE)
  data.frame(x = prodWaste_samples, y= releaseData$y)
}

uniform_ProdWaste <- transform2uniform(indReleaseTest$PROD._WASTE_.8.1_THRU_8.7.)
#uniform_Release <- transform2uniform(indReleaseTest$TOTAL_RELEASES)
uniform_Reuse <- transform2uniform(indReleaseTest$TOTAL_REUSE)
#uniform_DataRelease <- data.frame(x = uniform_ProdWaste, y = uniform_Release)
uniform_DataReuse <- data.frame(x = uniform_ProdWaste, y = uniform_Reuse)

scatterPlot <- function(data, subjectNo) {
  plot(data$x, data$y, # Assume data has these named components
       main=paste(subjectNo), cex.main = 2,# display subject number
       ylab="", xlab="", xaxt="n", yaxt="n", # remove axes
       pch=19, col=adjustcolor("steelblue", 0.5), cex=1.75 # the points
  )
  points(data$x, data$y, pch=1, col="grey30", cex=1.5) # adds point outlines
}

#hide location function
hideLocation <- function(trueLoc, nSubjects){
  possibleBaseVals <- 3:min(2*nSubjects, 50)
  # remove easy base values
  possibleBaseVals <- possibleBaseVals[possibleBaseVals != 10 &
                                         possibleBaseVals != 5]
  base <- sample(possibleBaseVals, 1)
  offset <- sample(5:min(5*nSubjects, 125),1)
  # return location information (trueLoc hidden)
  list(trueLoc = paste0("log(",base^(trueLoc + offset), ", base=",base,") -
                        ", offset))
}

#reveal Location
revealLocation <- function(hiddenLocation){
  eval(parse(text=hiddenLocation$trueLoc))}


#Lineup Function to generate
lineup <- function(data, showSubject=NULL, generateSubject=NULL,
                   trueLoc=NULL, layout =c(5,4)
) {
  # Get the total number of subjects
  nSubjects <- layout[1] * layout[2]
  # Get the location to be used for the real data
  if (is.null(trueLoc)) {trueLoc <- sample(1:nSubjects, 1)}
  # Error checking
  if (is.null(showSubject)) {stop("need a plot function for the subject")}
  if (is.null(generateSubject)) {stop("need a function to generate subject")}
  # Local function to decide which subject to present
  presentSubject <- function(subjectNo) {
    if(subjectNo != trueLoc) {data <- generateSubject(data)}
    showSubject(data, subjectNo) }
  # This does the plotting
  savePar <- par(mfrow=layout, mar=c(2.5, 0.1, 3, 0.1), oma=rep(0,4))
  sapply(1:nSubjects, FUN = presentSubject)
  par(savePar)
  print(trueLoc)
  # hide the true location but return information to reconstruct it.
  #hideLocation(trueLoc, nSubjects)
}
#set.seed(35521)

answer <- lineup(uniform_DataReuse,
                 generateSubject = mixCoordinates3,
                 showSubject = scatterPlot,
                 layout=c(4,5))

```



As it can be clearly seen from the lineup plots that one of them is visually different from all others(probabilty of observing something atleast as strange as the observed data =1/20) 
and that corresponds to the data, which clearly indicates strong evidence against the null hypothesis that Total Reuse of Produced Chemical Waste by a state's industrial facilities is independent of the Total Produced Chemical Waste by industrial facilities of that state(2016).
It is showing a strong positive correlation between the Production waste and Total Reuse of each state.
r = 0.98


#**Conclusion**

```{r, total release, include=FALSE}
library(plyr)
listYear <- c("2006","2006","2016","2016")
listReuseReleaseVal <- c(totalRelease2006,totalReuse2006,totalRelease2016,totalReuse2016)
listReuseReleaseNames <- c("Total_Release","Total_Reuse","Total_Release","Total_Reuse")

total2016_2006 <- data.frame("year" = listYear,"Values"= listReuseReleaseVal,"Production_Waste" = listReuseReleaseNames)




total2016_2006 = plyr::ddply(total2016_2006, .(year), transform, percent = Values/sum(Values) * 100)

total2016_2006 = plyr::ddply(total2016_2006, .(year), transform,
              pos = (cumsum(Values) - 0.1*Values)/sum(Values))

total2016_2006$label = paste0(sprintf("%.0f", 100-total2016_2006$percent), "%")

```

```{r}
ggplot(total2016_2006, aes(x = factor(year), y = Values, fill = Production_Waste)) +
  geom_bar(stat = "identity", position = "fill", width = .7,alpha = 0.5) +    
  geom_text(aes(y = pos, label = label), size = 2) +
  coord_flip()
```

 + The total Release of chemicals has gone down which was 18% (4.09 Billion pounds) of the total produced chemcial waste (22.2 Billion pounds) in 2006 while in 2016, the total Release of chemicals is 13% (3.90 Billion pounds) of the total produced chemcial waste (29.6 Billion pounds).
 
Thus, the reuse of chemicals by industrial facilities has gone up from 82% in 2006 to 87% in 2016.
So, overall a 5% increase in Reuse can be seen form 2006 to 2016.


```{r,Air water Land 1release, include=FALSE}
listYear3 <- c("2006","2006","2006","2016","2016","2016")
listReleaseVal <- c(totalWaterRelease2006,totalOtherRelease2006,totalAirRelease2006,totalWaterRelease2016,totalOtherRelease2016,totalAirRelease2016)
listReleaseNames <- c("Water_Release","Land_Release","Air_Release","Water_Release","Land_Release","Air_Release")

totalRelease2016_2006 <- data.frame("year" = listYear3,"Values"= listReleaseVal,"Release" = listReleaseNames)

totalRelease2016_2006 = plyr::ddply(totalRelease2016_2006, .(year), transform, percent = Values/sum(Values) * 100)

totalRelease2016_2006 = plyr::ddply(totalRelease2016_2006, .(year), transform,
                       pos = (cumsum(Values) - 0.5*Values)/sum(Values))

totalRelease2016_2006$label = paste0(sprintf("%.0f", totalRelease2016_2006$percent), "%")

```

```{r}
ggplot(totalRelease2016_2006, aes(x = factor(year), y = Values, fill = Release)) +
  geom_bar(stat = "identity", position = "fill", width = .7,alpha = 0.5) +    
  geom_text(aes(y = pos, label = label), size = 2)
```

 + Also, the releases to air have gone down from 30% to 17% which is a good thing.
A drop of 1% in water releases from 2006 to 2016.While, there is an increase in the Land Release from 64% to 78%.


```{r, total Reuse, include=FALSE}
listReuseVal <- c(totalTreatment2006,totalRecyle2006,totalRecovery2006,totalTreatment2016,totalRecyle2016,totalRecovery2016)
 
listReuseNames <- c("Treatment","Recycle","Recovery","Treatment","Recycle","Recovery") 

totalReuse2016_2006 <- data.frame("year" = listYear3,"Values"= listReuseVal,"Reuse" = listReuseNames)

totalReuse2016_2006 = ddply(totalReuse2016_2006, .(year), transform, percent = Values/sum(Values) * 100)

totalReuse2016_2006 = ddply(totalReuse2016_2006, .(year), transform,
                              pos = (cumsum(Values) - 0.5*Values)/sum(Values))

totalReuse2016_2006$label = paste0(sprintf("%.0f", totalReuse2016_2006$percent), "%")

```


```{r}
ggplot(totalReuse2016_2006, aes(x = factor(year), y = Values, fill = Reuse)) +
  geom_bar(stat = "identity", position = "fill", width = .7,alpha = 0.5) +    
  geom_text(aes(y = pos, label = label), size = 2)
```


 + The total Reuse of Chemicals has gone up from 2006 to 2016, Recylcing of chemicals is the most preferred way and it has gone up i.e. it was 44% in 2006 and in 2016 its 50% and decrease in recovery of chemicals from 15% to 12% and treatment from 41% to 37%.


 + Texas was the most Carcenogic releasing state in 2006 and its still the most Carcinogenic Releasing state in 2016.

 + Texas is the state which is reusing the wastes generated maximum.

 + Alaska is the most Toxic chemical releasing state in 2016.

 + Metal Mining industry is the most Toxic chemical releasing Industry in the United States both in 2006 and 2016 and releases PBT chemicals namely Lead and Mercury Compounds.

 + Chemical industry is the one which reuses the waste generated Maximum.

 + Also Chemical industry releases the most carcinogenic chemicals to the environment.

 + Arsenic Compounds are the most hazardous chemicals released into the environment primarily by Metal Mining Industry.

So, we can say that overall the chemical releases have gone down and chemical reuse has gone up from 2006 to 2016.

#References
 1. http://www.riotinto.com/ourcommitment/spotlight-18130_19552.aspx
 2. https://dilemma-x.net/2016/12/21/u-s-state-populations-2016-most-populous-states/
 3. https://www.epa.gov/toxics-release-inventory-tri-program/tri-basic-data-files-calendar-years-1987-2016